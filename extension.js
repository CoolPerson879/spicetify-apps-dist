"use strict";var betterDlocalDfiles=(()=>{var D=Object.create,s=Object.defineProperty,F=Object.getOwnPropertyDescriptor,c=Object.getOwnPropertyNames,R=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty,t=(t,e)=>function(){return e||(0,t[c(t)[0]])((e={exports:{}}).exports,e),e.exports},e=(t,e,r)=>{r=null!=t?D(R(t)):{};var n=!e&&t&&t.__esModule?r:s(r,"default",{value:t,enumerable:!0}),o=t,i=void 0,a=void 0;if(o&&"object"==typeof o||"function"==typeof o)for(let t of c(o))U.call(n,t)||t===i||s(n,t,{get:()=>o[t],enumerable:!(a=F(o,t))||a.enumerable});return n},r=t({"node_modules/pixelmatch/index.js"(t,e){var y={threshold:.1,includeAA:!(e.exports=function(r,n,o,i,a,s){if(!b(r)||!b(n)||o&&!b(o))throw new Error("Image data: Uint8Array, Uint8ClampedArray or Buffer expected.");if(r.length!==n.length||o&&o.length!==r.length)throw new Error("Image sizes do not match.");if(r.length!==i*a*4)throw new Error("Image data size does not match width/height.");s=Object.assign({},y,s);var e=i*a,c=new Uint32Array(r.buffer,r.byteOffset,e),u=new Uint32Array(n.buffer,n.byteOffset,e);let l=!0;for(let t=0;t<e;t++)if(c[t]!==u[t]){l=!1;break}if(l){if(o&&!s.diffMask)for(let t=0;t<e;t++)_(r,4*t,s.alpha,o);return 0}var f=35215*s.threshold*s.threshold;let h=0;for(let e=0;e<a;e++)for(let t=0;t<i;t++){var p=4*(e*i+t),d=w(r,n,p,p);Math.abs(d)>f?s.includeAA||!v(r,t,e,i,a,n)&&!v(n,t,e,i,a,r)?(o&&m(o,p,...d<0&&s.diffColorAlt||s.diffColor),h++):o&&!s.diffMask&&m(o,p,...s.aaColor):o&&!s.diffMask&&_(r,p,s.alpha,o)}return h}),alpha:.1,aaColor:[255,255,0],diffColor:[255,0,0],diffColorAlt:null,diffMask:!1};function b(t){return ArrayBuffer.isView(t)&&1===t.constructor.BYTES_PER_ELEMENT}function v(r,n,o,i,t,e){var a=Math.max(n-1,0),s=Math.max(o-1,0),c=Math.min(n+1,i-1),u=Math.min(o+1,t-1),l=4*(o*i+n);let f=n===a||n===c||o===s||o===u?1:0,h=0,p=0,d,y,b,v;for(let e=a;e<=c;e++)for(let t=s;t<=u;t++)if(e!==n||t!==o){var m=w(r,r,l,4*(t*i+e),!0);if(0===m){if(2<++f)return}else m<h?(h=m,d=e,y=t):m>p&&(p=m,b=e,v=t)}return 0!==h&&0!==p&&(g(r,d,y,i,t)&&g(e,d,y,i,t)||g(r,b,v,i,t)&&g(e,b,v,i,t))}function g(r,n,o,i,t){var a=Math.max(n-1,0),s=Math.max(o-1,0),c=Math.min(n+1,i-1),u=Math.min(o+1,t-1),l=4*(o*i+n);let f=n===a||n===c||o===s||o===u?1:0;for(let e=a;e<=c;e++)for(let t=s;t<=u;t++)if(e!==n||t!==o){var h=4*(t*i+e);if(r[l]===r[h]&&r[1+l]===r[1+h]&&r[2+l]===r[2+h]&&r[3+l]===r[3+h]&&f++,2<f)return!0}return!1}function w(t,e,r,n,o){let i=t[r+0],a=t[r+1],s=t[r+2];t=t[r+3];let c=e[n+0],u=e[n+1],l=e[n+2];r=e[n+3];if(t===r&&i===c&&a===u&&s===l)return 0;t<255&&(t/=255,i=d(i,t),a=d(a,t),s=d(s,t)),r<255&&(r/=255,c=d(c,r),u=d(u,r),l=d(l,r));var e=f(i,a,s),n=f(c,u,l),t=e-n;return!o&&(t=.5053*t*t+.299*(r=h(i,a,s)-h(c,u,l))*r+.1957*(o=p(i,a,s)-p(c,u,l))*o,n<e)?-t:t}function f(t,e,r){return.29889531*t+.58662247*e+.11448223*r}function h(t,e,r){return.59597799*t-.2741761*e-.32180189*r}function p(t,e,r){return.21147017*t-.52261711*e+.31114694*r}function d(t,e){return 255+(t-255)*e}function m(t,e,r,n,o){t[e+0]=r,t[e+1]=n,t[e+2]=o,t[e+3]=255}function _(t,e,r,n){r=d(f(t[e+0],t[e+1],t[e+2]),r*t[e+3]/255);m(n,e,r,r,r)}}}),t=t({"node_modules/tslib/tslib.js"(t,n){var e,r,i,a,s,c,u,l,f,h,p,d,y,b,v,m,g,w,_,S,x,O,j,P,k,T,E,I,A;!function(e){var o="object"==typeof global?global:"object"==typeof self?self:"object"==typeof this?this:{};function r(r,n){return r!==o&&("function"==typeof Object.create?Object.defineProperty(r,"__esModule",{value:!0}):r.__esModule=!0),function(t,e){return r[t]=n?n(t,e):e}}"function"==typeof define&&define.amd?define("tslib",["exports"],function(t){e(r(o,r(t)))}):"object"==typeof n&&"object"==typeof n.exports?e(r(o,r(n.exports))):e(r(o))}(function(t){var n=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,e){t.__proto__=e}:function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}),o=(e=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},r=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},i=function(t,e){var r={};for(o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.indexOf(o)<0&&(r[o]=t[o]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var n=0,o=Object.getOwnPropertySymbols(t);n<o.length;n++)e.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(t,o[n])&&(r[o[n]]=t[o[n]]);return r},a=function(t,e,r,n){var o,i=arguments.length,a=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;0<=s;s--)(o=t[s])&&(a=(i<3?o(a):3<i?o(e,r,a):o(e,r))||a);return 3<i&&a&&Object.defineProperty(e,r,a),a},s=function(r,n){return function(t,e){n(t,e,r)}},c=function(t,e,r,n,o,i){function a(t){if(void 0!==t&&"function"!=typeof t)throw new TypeError("Function expected");return t}for(var s,c=n.kind,u="getter"===c?"get":"setter"===c?"set":"value",t=!e&&t?n.static?t:t.prototype:null,l=e||(t?Object.getOwnPropertyDescriptor(t,n.name):{}),f=!1,h=r.length-1;0<=h;h--){var p,d={};for(p in n)d[p]="access"===p?{}:n[p];for(p in n.access)d.access[p]=n.access[p];d.addInitializer=function(t){if(f)throw new TypeError("Cannot add initializers after decoration has completed");i.push(a(t||null))};var y=(0,r[h])("accessor"===c?{get:l.get,set:l.set}:l[u],d);if("accessor"===c){if(void 0!==y){if(null===y||"object"!=typeof y)throw new TypeError("Object expected");(s=a(y.get))&&(l.get=s),(s=a(y.set))&&(l.set=s),(s=a(y.init))&&o.push(s)}}else(s=a(y))&&("field"===c?o.push(s):l[u]=s)}t&&Object.defineProperty(t,n.name,l),f=!0},u=function(t,e,r){for(var n=2<arguments.length,o=0;o<e.length;o++)r=n?e[o].call(t,r):e[o].call(t);return n?r:void 0},l=function(t){return"symbol"==typeof t?t:"".concat(t)},f=function(t,e,r){return"symbol"==typeof e&&(e=e.description?"[".concat(e.description,"]"):""),Object.defineProperty(t,"name",{configurable:!0,value:r?"".concat(r," ",e):e})},h=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},p=function(t,a,s,c){return new(s=s||Promise)(function(r,e){function n(t){try{i(c.next(t))}catch(t){e(t)}}function o(t){try{i(c.throw(t))}catch(t){e(t)}}function i(t){var e;t.done?r(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(n,o)}i((c=c.apply(t,a||[])).next())})},d=function(n,o){var i,a,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},u={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function t(r){return function(t){var e=[r,t];if(i)throw new TypeError("Generator is already executing.");for(;c=u&&e[u=0]?0:c;)try{if(i=1,a&&(s=2&e[0]?a.return:e[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,e[1])).done)return s;switch(a=0,(e=s?[2&e[0],s.value]:e)[0]){case 0:case 1:s=e;break;case 4:return c.label++,{value:e[1],done:!1};case 5:c.label++,a=e[1],e=[0];continue;case 7:e=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){c=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3]))c.label=e[1];else if(6===e[0]&&c.label<s[1])c.label=s[1],s=e;else{if(!(s&&c.label<s[2])){s[2]&&c.ops.pop(),c.trys.pop();continue}c.label=s[2],c.ops.push(e)}}e=o.call(n,c)}catch(t){e=[6,t],a=0}finally{i=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}}},y=function(t,e){for(var r in t)"default"===r||Object.prototype.hasOwnProperty.call(e,r)||A(e,t,r)},A=Object.create?function(t,e,r,n){void 0===n&&(n=r);var o=Object.getOwnPropertyDescriptor(e,r);o&&("get"in o?e.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,o)}:function(t,e,r,n){t[n=void 0===n?r:n]=e[r]},b=function(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return{value:(t=t&&n>=t.length?void 0:t)&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},v=function(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,o,i=r.call(t),a=[];try{for(;(void 0===e||0<e--)&&!(n=i.next()).done;)a.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return a},m=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(v(arguments[e]));return t},g=function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;for(var n=Array(t),o=0,e=0;e<r;e++)for(var i=arguments[e],a=0,s=i.length;a<s;a++,o++)n[o]=i[a];return n},w=function(t,e,r){if(r||2===arguments.length)for(var n,o=0,i=e.length;o<i;o++)!n&&o in e||((n=n||Array.prototype.slice.call(e,0,o))[o]=e[o]);return t.concat(n||Array.prototype.slice.call(e))},_=function(t){return this instanceof _?(this.v=t,this):new _(t)},S=function(t,e,r){var o,i,a;if(Symbol.asyncIterator)return o=r.apply(t,e||[]),i=[],a={},n("next"),n("throw"),n("return"),a[Symbol.asyncIterator]=function(){return this},a;throw new TypeError("Symbol.asyncIterator is not defined.");function n(n){o[n]&&(a[n]=function(r){return new Promise(function(t,e){1<i.push([n,r,t,e])||s(n,r)})})}function s(t,e){try{(r=o[t](e)).value instanceof _?Promise.resolve(r.value.v).then(c,u):l(i[0][2],r)}catch(t){l(i[0][3],t)}var r}function c(t){s("next",t)}function u(t){s("throw",t)}function l(t,e){t(e),i.shift(),i.length&&s(i[0][0],i[0][1])}},x=function(n){var o,t={};return e("next"),e("throw",function(t){throw t}),e("return"),t[Symbol.iterator]=function(){return this},t;function e(e,r){t[e]=n[e]?function(t){return(o=!o)?{value:_(n[e](t)),done:!1}:r?r(t):t}:r}},O=function(a){var t,e;if(Symbol.asyncIterator)return(t=a[Symbol.asyncIterator])?t.call(a):(a=b(a),e={},r("next"),r("throw"),r("return"),e[Symbol.asyncIterator]=function(){return this},e);throw new TypeError("Symbol.asyncIterator is not defined.");function r(i){e[i]=a[i]&&function(o){return new Promise(function(t,e){var r,n;o=a[i](o),r=t,t=e,n=o.done,e=o.value,Promise.resolve(e).then(function(t){r({value:t,done:n})},t)})}}},j=function(t,e){return Object.defineProperty?Object.defineProperty(t,"raw",{value:e}):t.raw=e,t},Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e});P=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)"default"!==r&&Object.prototype.hasOwnProperty.call(t,r)&&A(e,t,r);return o(e,t),e},k=function(t){return t&&t.__esModule?t:{default:t}},T=function(t,e,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t===e&&n:e.has(t))return"m"===r?n:"a"===r?n.call(t):n?n.value:e.get(t);throw new TypeError("Cannot read private member from an object whose class did not declare it")},E=function(t,e,r,n,o){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t===e&&o:e.has(t))return"a"===n?o.call(t,r):o?o.value=r:e.set(t,r),r;throw new TypeError("Cannot write private member to an object whose class did not declare it")},I=function(t,e){if(null===e||"object"!=typeof e&&"function"!=typeof e)throw new TypeError("Cannot use 'in' operator on non-object");return"function"==typeof t?e===t:t.has(e)},t("__extends",e),t("__assign",r),t("__rest",i),t("__decorate",a),t("__param",s),t("__esDecorate",c),t("__runInitializers",u),t("__propKey",l),t("__setFunctionName",f),t("__metadata",h),t("__awaiter",p),t("__generator",d),t("__exportStar",y),t("__createBinding",A),t("__values",b),t("__read",v),t("__spread",m),t("__spreadArrays",g),t("__spreadArray",w),t("__await",_),t("__asyncGenerator",S),t("__asyncDelegator",x),t("__asyncValues",O),t("__makeTemplateObject",j),t("__importStar",P),t("__importDefault",k),t("__classPrivateFieldGet",T),t("__classPrivateFieldSet",E),t("__classPrivateFieldIn",I)})}}),H=(t,e,r)=>{var n=r;if("string"!=typeof n)throw new TypeError("Invalid operator type, expected string but got "+typeof n);if(-1===Y.indexOf(n))throw new Error("Invalid operator, expected one of "+Y.join("|"));n=e,e=J(e=t),n=J(n),t=e.pop(),o=n.pop();var o,n=0!==(e=V(e,n))?e:t&&o?V(t.split("."),o.split(".")):t||o?t?-1:1:0;return G[r].includes(n)},$=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,J=t=>{if("string"!=typeof t)throw new TypeError("Invalid argument expected string");var e=t.match($);if(e)return e.shift(),e;throw new Error(`Invalid argument not valid semver ('${t}' received)`)},L=t=>"*"===t||"x"===t||"X"===t,B=t=>{var e=parseInt(t,10);return isNaN(e)?t:e},K=(t,e)=>{return L(t)||L(e)?0:([t,e]=(t=B(t),e=B(e),typeof t!=typeof e?[String(t),String(e)]:[t,e]),e<t?1:t<e?-1:0)},V=(e,r)=>{for(let t=0;t<Math.max(e.length,r.length);t++){var n=K(e[t]||"0",r[t]||"0");if(0!==n)return n}return 0},G={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1],"!=":[-1,1]},Y=Object.keys(G);function i(){return Spicetify.Platform}async function W(t,e){e=await(await(await fetch(`https://raw.githubusercontent.com/Pithaya/spicetify-apps/main/custom-apps/${e}/package.json`)).json()).version;return H(t,e,">=")}function w(t,e,r){r="descending"===r?-1:1;return e<t?r:t<e?-1*r:0}var X=class{constructor(t,e,r){this.uri=t,this.name=e,this.image=r,this.artists=[],this.discs=new Map}getTracks(){const r=[];return this.discs.forEach((t,e)=>r.push(...t)),r}getDuration(){return this.getTracks().map(t=>t.duration).reduce((t,e)=>t+e)}},q=class{constructor(t,e){this.name=t,this.image=e,this.uri="spotify:local:"+t}},Q=class{constructor(t,e,r){this.localTrack=t,this.album=e,this.artists=r}get addedAt(){return this.localTrack.addedAt}get uri(){return this.localTrack.uri}get name(){return this.localTrack.name}get duration(){return this.localTrack.duration.milliseconds}get discNumber(){return this.localTrack.discNumber}get trackNumber(){return this.localTrack.trackNumber}},Z=e(r()),{__extends:r,__values:f,__read:h,__spreadArray:p}=e(t(),1).default;function d(t){return"function"==typeof t}function tt(t){t=t(function(t){Error.call(t),t.stack=(new Error).stack});return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t}var y=tt(function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map(function(t,e){return e+1+") "+t.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}});function a(t,e){t&&0<=(e=t.indexOf(e))&&t.splice(e,1)}n.prototype.unsubscribe=function(){var e,t,r;if(!this.closed){this.closed=!0;var n=this._parentage;if(n)if(this._parentage=null,Array.isArray(n))try{for(var o=f(n),i=o.next();!i.done;i=o.next())i.value.remove(this)}catch(t){s={error:t}}finally{try{i&&!i.done&&(a=o.return)&&a.call(o)}finally{if(s)throw s.error}}else n.remove(this);var a=this.initialTeardown;if(d(a))try{a()}catch(t){r=t instanceof y?t.errors:[t]}var s=this._finalizers;if(s){this._finalizers=null;try{for(var c=f(s),u=c.next();!u.done;u=c.next()){var l=u.value;try{nt(l)}catch(t){r=null!=r?r:[],t instanceof y?r=p(p([],h(r)),h(t.errors)):r.push(t)}}}catch(t){e={error:t}}finally{try{u&&!u.done&&(t=c.return)&&t.call(c)}finally{if(e)throw e.error}}}if(r)throw new y(r)}},n.prototype.add=function(t){var e;if(t&&t!==this)if(this.closed)nt(t);else{if(t instanceof n){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!=(e=this._finalizers)?e:[]).push(t)}},n.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},n.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},n.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&a(e,t)},n.prototype.remove=function(t){var e=this._finalizers;e&&a(e,t),t instanceof n&&t._removeParent(this)},n.EMPTY=((e=new n).closed=!0,e);var u=n;function n(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}var et=u.EMPTY;function rt(t){return t instanceof u||t&&"closed"in t&&d(t.remove)&&d(t.add)&&d(t.unsubscribe)}function nt(t){d(t)?t():t.unsubscribe()}var o={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},l={setTimeout:function(t,e){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var o=l.delegate;return null!=o&&o.setTimeout?o.setTimeout.apply(o,p([t,e],h(r))):setTimeout.apply(void 0,p([t,e],h(r)))},clearTimeout:function(t){var e=l.delegate;return((null==e?void 0:e.clearTimeout)||clearTimeout)(t)},delegate:void 0};function ot(){}var it=b("C",void 0,void 0);function b(t,e,r){return{kind:t,value:e,error:r}}var v=null;function m(t){if(o.useDeprecatedSynchronousErrorHandling){var e=!v;if(e&&(v={errorThrown:!1,error:null}),t(),e){var e=v,r=e.errorThrown,e=e.error;if(v=null,r)throw e}}else t()}r(_,g=u),_.create=function(t,e,r){return new O(t,e,r)},_.prototype.next=function(t){this.isStopped?P(b("N",t,void 0),this):this._next(t)},_.prototype.error=function(t){this.isStopped?P(b("E",void 0,t),this):(this.isStopped=!0,this._error(t))},_.prototype.complete=function(){this.isStopped?P(it,this):(this.isStopped=!0,this._complete())},_.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,g.prototype.unsubscribe.call(this),this.destination=null)},_.prototype._next=function(t){this.destination.next(t)},_.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},_.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}};var g,at=_;function _(t){var e=g.call(this)||this;return e.isStopped=!1,t?rt(e.destination=t)&&t.add(e):e.destination=ft,e}var st=Function.prototype.bind;function S(t,e){return st.call(t,e)}x.prototype.next=function(t){var e=this.partialObserver;if(e.next)try{e.next(t)}catch(t){j(t)}},x.prototype.error=function(t){var e=this.partialObserver;if(e.error)try{e.error(t)}catch(t){j(t)}else j(t)},x.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(t){j(t)}};var ct=x;function x(t){this.partialObserver=t}r(lt,ut=at);var ut,O=lt;function lt(t,e,r){var n=ut.call(this)||this;return r=d(t)||!t?{next:null!=t?t:void 0,error:null!=e?e:void 0,complete:null!=r?r:void 0}:n&&o.useDeprecatedNextContext?((e=Object.create(t)).unsubscribe=function(){return n.unsubscribe()},{next:t.next&&S(t.next,e),error:t.error&&S(t.error,e),complete:t.complete&&S(t.complete,e)}):t,n.destination=new ct(r),n}function j(t){var e,r;o.useDeprecatedSynchronousErrorHandling?(r=t,o.useDeprecatedSynchronousErrorHandling&&v&&(v.errorThrown=!0,v.error=r)):(e=t,l.setTimeout(function(){var t=o.onUnhandledError;if(!t)throw e;t(e)}))}function P(t,e){var r=o.onStoppedNotification;r&&l.setTimeout(function(){return r(t,e)})}var ft={closed:!0,next:ot,error:function(t){throw t},complete:ot},t="function"==typeof Symbol&&Symbol.observable||"@@observable";function ht(t){return t}k.prototype.lift=function(t){var e=new k;return e.source=this,e.operator=t,e},k.prototype.subscribe=function(t,e,r){var n,o=this,i=(n=t)&&n instanceof at||function(t){return t&&d(t.next)&&d(t.error)&&d(t.complete)}(n)&&rt(n)?t:new O(t,e,r);return m(function(){var t=o.operator,e=o.source;i.add(t?t.call(i,e):e?o._subscribe(i):o._trySubscribe(i))}),i},k.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},k.prototype.forEach=function(n,t){var o=this;return new(t=dt(t))(function(t,e){var r=new O({next:function(t){try{n(t)}catch(t){e(t),r.unsubscribe()}},error:e,complete:t});o.subscribe(r)})},k.prototype._subscribe=function(t){var e;return null==(e=this.source)?void 0:e.subscribe(t)},k.prototype[t]=function(){return this},k.prototype.pipe=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return(0===(e=t).length?ht:1===e.length?e[0]:function(t){return e.reduce(function(t,e){return e(t)},t)})(this)},k.prototype.toPromise=function(t){var n=this;return new(t=dt(t))(function(t,e){var r;n.subscribe(function(t){return r=t},function(t){return e(t)},function(){return t(r)})})},k.create=function(t){return new k(t)};var pt=k;function k(t){t&&(this._subscribe=t)}function dt(t){return null!=(t=null!=t?t:o.Promise)?t:Promise}var T,yt=tt(function(t){return function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),e=(r(E,T=pt),E.prototype.lift=function(t){var e=new vt(this,this);return e.operator=t,e},E.prototype._throwIfClosed=function(){if(this.closed)throw new yt},E.prototype.next=function(o){var i=this;m(function(){var e,t;if(i._throwIfClosed(),!i.isStopped){i.currentObservers||(i.currentObservers=Array.from(i.observers));try{for(var r=f(i.currentObservers),n=r.next();!n.done;n=r.next())n.value.next(o)}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}}})},E.prototype.error=function(e){var r=this;m(function(){if(r._throwIfClosed(),!r.isStopped){r.hasError=r.isStopped=!0,r.thrownError=e;for(var t=r.observers;t.length;)t.shift().error(e)}})},E.prototype.complete=function(){var e=this;m(function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var t=e.observers;t.length;)t.shift().complete()}})},E.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(E.prototype,"observed",{get:function(){var t;return 0<(null==(t=this.observers)?void 0:t.length)},enumerable:!1,configurable:!0}),E.prototype._trySubscribe=function(t){return this._throwIfClosed(),T.prototype._trySubscribe.call(this,t)},E.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},E.prototype._innerSubscribe=function(t){var e=this,r=this.hasError,n=this.isStopped,o=this.observers;return r||n?et:(this.currentObservers=null,o.push(t),new u(function(){e.currentObservers=null,a(o,t)}))},E.prototype._checkFinalizedStatuses=function(t){var e=this.hasError,r=this.thrownError,n=this.isStopped;e?t.error(r):n&&t.complete()},E.prototype.asObservable=function(){var t=new pt;return t.source=this,t},E.create=function(t,e){return new vt(t,e)},E);function E(){var t=T.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}r(I,bt=e),I.prototype.next=function(t){var e,r;null!=(r=null==(e=this.destination)?void 0:e.next)&&r.call(e,t)},I.prototype.error=function(t){var e,r;null!=(r=null==(e=this.destination)?void 0:e.error)&&r.call(e,t)},I.prototype.complete=function(){var t,e;null!=(e=null==(t=this.destination)?void 0:t.complete)&&e.call(t)},I.prototype._subscribe=function(t){var e;return null!=(e=null==(e=this.source)?void 0:e.subscribe(t))?e:et};var bt,vt=I;function I(t,e){var r=bt.call(this)||this;return r.destination=t,r.source=e,r}r(N,A=e),Object.defineProperty(N.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),N.prototype._subscribe=function(t){var e=A.prototype._subscribe.call(this,t);return e.closed||t.next(this._value),e},N.prototype.getValue=function(){var t=this.hasError,e=this.thrownError,r=this._value;if(t)throw e;return this._throwIfClosed(),r},N.prototype.next=function(t){A.prototype.next.call(this,this._value=t)};var A,C=N;function N(t){var e=A.call(this)||this;return e._value=t,e}var M="local-files:has-cache",z="local-files:merged-albums",mt=class{get hasCache(){let t=localStorage.getItem(M);var e;return null===t&&(e=JSON.stringify(!0),localStorage.setItem(M,e),t=e),JSON.parse(t)}set hasCache(t){localStorage.setItem(M,JSON.stringify(t))}get cache(){let t=localStorage.getItem(z);var e;return null===t&&(e=JSON.stringify([]),localStorage.setItem(z,e),t=e),JSON.parse(t)}set cache(t){localStorage.setItem(z,JSON.stringify(t))}},gt=class{constructor(){this.storageService=new mt,this.isInitializedSubject=new C(!1),this.isInitializing=!1,this.isReady$=this.isInitializedSubject.asObservable(),this.tracks=new Map,this.albums=new Map,this.artists=new Map,this.processedAlbumsSubject=new C(0),this.processedAlbums$=this.processedAlbumsSubject.asObservable(),this.albumCountSubject=new C(0),this.albumCount$=this.albumCountSubject.asObservable()}get isReady(){return this.isInitializedSubject.value}getTracks(){return this.tracks}getAlbums(){return this.albums}getArtists(){return this.artists}getArtistTracks(e){return Array.from(this.tracks.values()).filter(t=>t.artists.some(t=>t.uri===e)).sort((t,e)=>w(t.album.name,e.album.name,"ascending")||w(t.discNumber,e.discNumber,"ascending")||w(t.trackNumber,e.trackNumber,"ascending"))}getDisplayName(t){return""===t?"Untitled":t}albumKeyFromName(t){return"spotify:uri:"+t.toLowerCase().replace(/\s/g,"+")}async clearCache(){this.isInitializedSubject.next(!1),this.storageService.cache=[],this.storageService.hasCache=!0,await this.init()}async reset(){this.isInitializedSubject.next(!1),this.storageService.cache=[],this.storageService.hasCache=!1,await this.init()}async init(){if(!this.isReady&&!this.isInitializing){this.isInitializing=!0,this.tracks=new Map,this.albums=new Map,this.artists=new Map;try{await this.processLocalTracks(),await this.postProcessAlbums()}catch(t){console.error(t),Spicetify.showNotification("Error while processing local files; clearing the cache: "+t,!0,5e3),this.storageService.cache=[],this.storageService.hasCache=!0}this.isInitializedSubject.next(!0),this.isInitializing=!1}}async processLocalTracks(){for(const n of await i().LocalFilesAPI.getTracks()){let r;var t=this.getDisplayName(n.album.name),e=this.albumKeyFromName(t),t=(this.albums.has(e)?r=this.albums.get(e):(r=new X(e,t,n.album.images[0].url),this.albums.set(e,r)),n.artists.flatMap(t=>this.getArtistsFromString(t.name,r.image)));for(let e of t)this.artists.has(e.uri)||this.artists.set(e.uri,e),r.artists.some(t=>t.uri===e.uri)||r.artists.push(e);e=new Q(n,r,t);this.tracks.set(e.uri,e),r.discs.has(n.discNumber)||r.discs.set(n.discNumber,[]),null!=(t=r.discs.get(n.discNumber))&&t.push(e)}}async postProcessAlbums(){var t,e,r,n,o,i=this.storageService.hasCache,a=[],s=[],c=[];this.albumCountSubject.next(this.albums.size);let u=0;for([e,r]of this.albums.entries()){this.processedAlbumsSubject.next(u+1),u++;var l=await this.postProcessAlbum(e,r);if(!(l.length<=1)){s.push(e);for(var[f,h]of l.entries())if(0!==h.tracks.length){var p=h.tracks[0],f=this.albumKeyFromName(r.name+" "+f),d=new X(f,r.name,p.localTrack.album.images[0].url);for(let e of p.artists)d.artists.some(t=>t.uri===e.uri)||d.artists.push(e);for(const v of h.tracks)(v.album=d).discs.has(v.localTrack.discNumber)||d.discs.set(v.localTrack.discNumber,[]),null!=(t=d.discs.get(v.localTrack.discNumber))&&t.push(v);c.push(d)}a.push({uri:e,tracks:l.map(t=>t.tracks.map(t=>t.uri))})}}i||(this.storageService.cache=a,this.storageService.hasCache=!0);for(const m of s)this.albums.delete(m);for(const g of c)this.albums.set(g.uri,g);for([n,o]of this.albums.entries())for(var[y,b]of o.discs.entries())o.discs.set(y,b.sort((t,e)=>w(t.trackNumber,e.trackNumber,"ascending")))}async postProcessAlbum(e,t){var r,n=this.storageService.hasCache,o=this.storageService.cache;let i=[];if(n){n=o.find(t=>t.uri===e);void 0!==n&&(i=n.tracks.map(t=>({cover:null,tracks:t.filter(t=>this.tracks.has(t)).map(t=>this.tracks.get(t))})))}else{if(t.artists.length<=1)return[];o=t.getTracks();if(o.length<=1)return[];var a,s,c=new Map;for(const f of o){var u=f.artists.map(t=>t.name).join(", ");c.has(u)?null!=(r=c.get(u))&&r.push(f):c.set(u,[f])}if(1===c.size)return[];for([a,s]of c.entries()){var l=s[0].localTrack.album.images[0].url,l=await this.getImage(l);const h=this.getImageDataFromCanvas(l);l=i.find(t=>0===this.getImageDifferenceWithPixelMatch(t.cover,h));void 0===l?i.push({tracks:s,cover:h}):l.tracks.push(...s)}}return i}getArtistsFromString(t,e){return t.split(/(?:,|;)/).map(t=>new q(this.getDisplayName(t.trim()),e))}async getImage(n){return new Promise((t,e)=>{const r=new Image;r.onload=()=>{t(r)},r.onerror=t=>{console.error(`Couldn't load image "${n}"`,t),e(t)},r.src=n})}getImageDataFromCanvas(t){var e=document.createElement("canvas"),e=(e.width=50,e.height=50,e.style.width="50px",e.style.height="50px",e.getContext("2d"));return e.drawImage(t,0,0,t.width,t.height,0,0,50,50),e.getImageData(0,0,50,50)}getImageDifferenceWithPixelMatch(t,e){return(0,Z.default)(t.data,e.data,null,t.width,t.height,{threshold:.1})}};(async()=>{for(window.localTracksService=new gt;!Spicetify?.Platform;)await new Promise(t=>setTimeout(t,100));await 0;const e=new Spicetify.Menu.Item("Rebuild local album cache",!1,()=>window.localTracksService.reset()),r=new Spicetify.Menu.Item("Clear local album cache",!1,()=>window.localTracksService.clearCache()),n=t=>{t.includes("better-local-files")?(e.register(),r.register()):(e.deregister(),r.deregister())};n(i().History.location.pathname),i().History.listen(t=>{n(t.pathname)}),async function(t,r){var n=i().History;const o=async()=>{await W(t,r)||Spicetify.showNotification("📢 A new version of the custom app is available.",!1,5e3)};if(n.location.pathname==="/"+r)await o();else{let e=null;e=n.listen(async t=>{t.pathname==="/"+r&&(await o(),e?.())})}}("1.0.0","better-local-files")})()})();