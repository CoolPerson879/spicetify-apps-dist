"use strict";var betterDlocalDfiles=(()=>{var F=Object.create,s=Object.defineProperty,D=Object.getOwnPropertyDescriptor,R=Object.getOwnPropertyNames,L=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty,t=(t,e)=>function(){return e||(0,t[R(t)[0]])((e={exports:{}}).exports,e),e.exports},e=(t,e,r)=>{r=null!=t?F(L(t)):{};var n=!e&&t&&t.__esModule?r:s(r,"default",{value:t,enumerable:!0}),i=t,o=void 0,a=void 0;if(i&&"object"==typeof i||"function"==typeof i)for(let t of R(i))U.call(n,t)||t===o||s(n,t,{get:()=>i[t],enumerable:!(a=D(i,t))||a.enumerable});return n},r=t({"external-global-plugin:react"(t,e){e.exports=Spicetify.React}}),n=t({"node_modules/pixelmatch/index.js"(t,e){var y={threshold:.1,includeAA:!(e.exports=function(r,n,i,o,a,s){if(!m(r)||!m(n)||i&&!m(i))throw new Error("Image data: Uint8Array, Uint8ClampedArray or Buffer expected.");if(r.length!==n.length||i&&i.length!==r.length)throw new Error("Image sizes do not match.");if(r.length!==o*a*4)throw new Error("Image data size does not match width/height.");s=Object.assign({},y,s);var e=o*a,c=new Uint32Array(r.buffer,r.byteOffset,e),l=new Uint32Array(n.buffer,n.byteOffset,e);let u=!0;for(let t=0;t<e;t++)if(c[t]!==l[t]){u=!1;break}if(u){if(i&&!s.diffMask)for(let t=0;t<e;t++)_(r,4*t,s.alpha,i);return 0}var f=35215*s.threshold*s.threshold;let p=0;for(let e=0;e<a;e++)for(let t=0;t<o;t++){var h=4*(e*o+t),d=P(r,n,h,h);Math.abs(d)>f?s.includeAA||!b(r,t,e,o,a,n)&&!b(n,t,e,o,a,r)?(i&&v(i,h,...d<0&&s.diffColorAlt||s.diffColor),p++):i&&!s.diffMask&&v(i,h,...s.aaColor):i&&!s.diffMask&&_(r,h,s.alpha,i)}return p}),alpha:.1,aaColor:[255,255,0],diffColor:[255,0,0],diffColorAlt:null,diffMask:!1};function m(t){return ArrayBuffer.isView(t)&&1===t.constructor.BYTES_PER_ELEMENT}function b(r,n,i,o,t,e){var a=Math.max(n-1,0),s=Math.max(i-1,0),c=Math.min(n+1,o-1),l=Math.min(i+1,t-1),u=4*(i*o+n);let f=n===a||n===c||i===s||i===l?1:0,p=0,h=0,d,y,m,b;for(let e=a;e<=c;e++)for(let t=s;t<=l;t++)if(e!==n||t!==i){var v=P(r,r,u,4*(t*o+e),!0);if(0===v){if(2<++f)return}else v<p?(p=v,d=e,y=t):v>h&&(h=v,m=e,b=t)}return 0!==p&&0!==h&&(g(r,d,y,o,t)&&g(e,d,y,o,t)||g(r,m,b,o,t)&&g(e,m,b,o,t))}function g(r,n,i,o,t){var a=Math.max(n-1,0),s=Math.max(i-1,0),c=Math.min(n+1,o-1),l=Math.min(i+1,t-1),u=4*(i*o+n);let f=n===a||n===c||i===s||i===l?1:0;for(let e=a;e<=c;e++)for(let t=s;t<=l;t++)if(e!==n||t!==i){var p=4*(t*o+e);if(r[u]===r[p]&&r[1+u]===r[1+p]&&r[2+u]===r[2+p]&&r[3+u]===r[3+p]&&f++,2<f)return!0}return!1}function P(t,e,r,n,i){let o=t[r+0],a=t[r+1],s=t[r+2];t=t[r+3];let c=e[n+0],l=e[n+1],u=e[n+2];r=e[n+3];if(t===r&&o===c&&a===l&&s===u)return 0;t<255&&(t/=255,o=d(o,t),a=d(a,t),s=d(s,t)),r<255&&(r/=255,c=d(c,r),l=d(l,r),u=d(u,r));var e=f(o,a,s),n=f(c,l,u),t=e-n;return!i&&(t=.5053*t*t+.299*(r=p(o,a,s)-p(c,l,u))*r+.1957*(i=h(o,a,s)-h(c,l,u))*i,n<e)?-t:t}function f(t,e,r){return.29889531*t+.58662247*e+.11448223*r}function p(t,e,r){return.59597799*t-.2741761*e-.32180189*r}function h(t,e,r){return.21147017*t-.52261711*e+.31114694*r}function d(t,e){return 255+(t-255)*e}function v(t,e,r,n,i){t[e+0]=r,t[e+1]=n,t[e+2]=i,t[e+3]=255}function _(t,e,r,n){r=d(f(t[e+0],t[e+1],t[e+2]),r*t[e+3]/255);v(n,e,r,r,r)}}}),t=t({"node_modules/tslib/tslib.js"(t,n){var e,r,o,a,s,c,l,u,f,p,h,d,y,m,b,v,g,P,_,w,S,A,I,O,x,j,E,k,T;!function(e){var i="object"==typeof global?global:"object"==typeof self?self:"object"==typeof this?this:{};function r(r,n){return r!==i&&("function"==typeof Object.create?Object.defineProperty(r,"__esModule",{value:!0}):r.__esModule=!0),function(t,e){return r[t]=n?n(t,e):e}}"function"==typeof define&&define.amd?define("tslib",["exports"],function(t){e(r(i,r(t)))}):"object"==typeof n&&"object"==typeof n.exports?e(r(i,r(n.exports))):e(r(i))}(function(t){var n=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,e){t.__proto__=e}:function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}),i=(e=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},r=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},o=function(t,e){var r={};for(i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(r[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var n=0,i=Object.getOwnPropertySymbols(t);n<i.length;n++)e.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(t,i[n])&&(r[i[n]]=t[i[n]]);return r},a=function(t,e,r,n){var i,o=arguments.length,a=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;0<=s;s--)(i=t[s])&&(a=(o<3?i(a):3<o?i(e,r,a):i(e,r))||a);return 3<o&&a&&Object.defineProperty(e,r,a),a},s=function(r,n){return function(t,e){n(t,e,r)}},c=function(t,e,r,n,i,o){function a(t){if(void 0!==t&&"function"!=typeof t)throw new TypeError("Function expected");return t}for(var s,c=n.kind,l="getter"===c?"get":"setter"===c?"set":"value",t=!e&&t?n.static?t:t.prototype:null,u=e||(t?Object.getOwnPropertyDescriptor(t,n.name):{}),f=!1,p=r.length-1;0<=p;p--){var h,d={};for(h in n)d[h]="access"===h?{}:n[h];for(h in n.access)d.access[h]=n.access[h];d.addInitializer=function(t){if(f)throw new TypeError("Cannot add initializers after decoration has completed");o.push(a(t||null))};var y=(0,r[p])("accessor"===c?{get:u.get,set:u.set}:u[l],d);if("accessor"===c){if(void 0!==y){if(null===y||"object"!=typeof y)throw new TypeError("Object expected");(s=a(y.get))&&(u.get=s),(s=a(y.set))&&(u.set=s),(s=a(y.init))&&i.push(s)}}else(s=a(y))&&("field"===c?i.push(s):u[l]=s)}t&&Object.defineProperty(t,n.name,u),f=!0},l=function(t,e,r){for(var n=2<arguments.length,i=0;i<e.length;i++)r=n?e[i].call(t,r):e[i].call(t);return n?r:void 0},u=function(t){return"symbol"==typeof t?t:"".concat(t)},f=function(t,e,r){return"symbol"==typeof e&&(e=e.description?"[".concat(e.description,"]"):""),Object.defineProperty(t,"name",{configurable:!0,value:r?"".concat(r," ",e):e})},p=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},h=function(t,a,s,c){return new(s=s||Promise)(function(r,e){function n(t){try{o(c.next(t))}catch(t){e(t)}}function i(t){try{o(c.throw(t))}catch(t){e(t)}}function o(t){var e;t.done?r(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(n,i)}o((c=c.apply(t,a||[])).next())})},d=function(n,i){var o,a,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},l={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function t(r){return function(t){var e=[r,t];if(o)throw new TypeError("Generator is already executing.");for(;c=l&&e[l=0]?0:c;)try{if(o=1,a&&(s=2&e[0]?a.return:e[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,e[1])).done)return s;switch(a=0,(e=s?[2&e[0],s.value]:e)[0]){case 0:case 1:s=e;break;case 4:return c.label++,{value:e[1],done:!1};case 5:c.label++,a=e[1],e=[0];continue;case 7:e=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){c=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3]))c.label=e[1];else if(6===e[0]&&c.label<s[1])c.label=s[1],s=e;else{if(!(s&&c.label<s[2])){s[2]&&c.ops.pop(),c.trys.pop();continue}c.label=s[2],c.ops.push(e)}}e=i.call(n,c)}catch(t){e=[6,t],a=0}finally{o=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}}},y=function(t,e){for(var r in t)"default"===r||Object.prototype.hasOwnProperty.call(e,r)||T(e,t,r)},T=Object.create?function(t,e,r,n){void 0===n&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);i&&("get"in i?e.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}:function(t,e,r,n){t[n=void 0===n?r:n]=e[r]},m=function(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return{value:(t=t&&n>=t.length?void 0:t)&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},b=function(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,i,o=r.call(t),a=[];try{for(;(void 0===e||0<e--)&&!(n=o.next()).done;)a.push(n.value)}catch(t){i={error:t}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return a},v=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(b(arguments[e]));return t},g=function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;for(var n=Array(t),i=0,e=0;e<r;e++)for(var o=arguments[e],a=0,s=o.length;a<s;a++,i++)n[i]=o[a];return n},P=function(t,e,r){if(r||2===arguments.length)for(var n,i=0,o=e.length;i<o;i++)!n&&i in e||((n=n||Array.prototype.slice.call(e,0,i))[i]=e[i]);return t.concat(n||Array.prototype.slice.call(e))},_=function(t){return this instanceof _?(this.v=t,this):new _(t)},w=function(t,e,r){var i,o,a;if(Symbol.asyncIterator)return i=r.apply(t,e||[]),o=[],a={},n("next"),n("throw"),n("return"),a[Symbol.asyncIterator]=function(){return this},a;throw new TypeError("Symbol.asyncIterator is not defined.");function n(n){i[n]&&(a[n]=function(r){return new Promise(function(t,e){1<o.push([n,r,t,e])||s(n,r)})})}function s(t,e){try{(r=i[t](e)).value instanceof _?Promise.resolve(r.value.v).then(c,l):u(o[0][2],r)}catch(t){u(o[0][3],t)}var r}function c(t){s("next",t)}function l(t){s("throw",t)}function u(t,e){t(e),o.shift(),o.length&&s(o[0][0],o[0][1])}},S=function(n){var i,t={};return e("next"),e("throw",function(t){throw t}),e("return"),t[Symbol.iterator]=function(){return this},t;function e(e,r){t[e]=n[e]?function(t){return(i=!i)?{value:_(n[e](t)),done:!1}:r?r(t):t}:r}},A=function(a){var t,e;if(Symbol.asyncIterator)return(t=a[Symbol.asyncIterator])?t.call(a):(a=m(a),e={},r("next"),r("throw"),r("return"),e[Symbol.asyncIterator]=function(){return this},e);throw new TypeError("Symbol.asyncIterator is not defined.");function r(o){e[o]=a[o]&&function(i){return new Promise(function(t,e){var r,n;i=a[o](i),r=t,t=e,n=i.done,e=i.value,Promise.resolve(e).then(function(t){r({value:t,done:n})},t)})}}},I=function(t,e){return Object.defineProperty?Object.defineProperty(t,"raw",{value:e}):t.raw=e,t},Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e});O=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)"default"!==r&&Object.prototype.hasOwnProperty.call(t,r)&&T(e,t,r);return i(e,t),e},x=function(t){return t&&t.__esModule?t:{default:t}},j=function(t,e,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t===e&&n:e.has(t))return"m"===r?n:"a"===r?n.call(t):n?n.value:e.get(t);throw new TypeError("Cannot read private member from an object whose class did not declare it")},E=function(t,e,r,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t===e&&i:e.has(t))return"a"===n?i.call(t,r):i?i.value=r:e.set(t,r),r;throw new TypeError("Cannot write private member to an object whose class did not declare it")},k=function(t,e){if(null===e||"object"!=typeof e&&"function"!=typeof e)throw new TypeError("Cannot use 'in' operator on non-object");return"function"==typeof t?e===t:t.has(e)},t("__extends",e),t("__assign",r),t("__rest",o),t("__decorate",a),t("__param",s),t("__esDecorate",c),t("__runInitializers",l),t("__propKey",u),t("__setFunctionName",f),t("__metadata",p),t("__awaiter",h),t("__generator",d),t("__exportStar",y),t("__createBinding",T),t("__values",m),t("__read",b),t("__spread",v),t("__spreadArrays",g),t("__spreadArray",P),t("__await",_),t("__asyncGenerator",w),t("__asyncDelegator",S),t("__asyncValues",A),t("__makeTemplateObject",I),t("__importStar",O),t("__importDefault",x),t("__classPrivateFieldGet",j),t("__classPrivateFieldSet",E),t("__classPrivateFieldIn",k)})}}),i=class{static get Session(){return Spicetify.Platform.Session}static get Transport(){return Spicetify.Platform.Transport}static get EventSender(){return Spicetify.Platform.EventSender}static get Translations(){return Spicetify.Platform.Translations}static get FeatureFlags(){return Spicetify.Platform.FeatureFlags}static get History(){return Spicetify.Platform.History}static get AdManagers(){return Spicetify.Platform.AdManagers}static get RemoteConfiguration(){return Spicetify.Platform.RemoteConfiguration}static get ActionStoreAPI(){return Spicetify.Platform.ActionStoreAPI}static get AuthorizationAPI(){return Spicetify.Platform.AuthorizationAPI}static get ClipboardAPI(){return Spicetify.Platform.ClipboardAPI}static get ConnectAPI(){return Spicetify.Platform.ConnectAPI}static get ControlMessageAPI(){return Spicetify.Platform.ControlMessageAPI}static get FacebookAPI(){return Spicetify.Platform.FacebookAPI}static get FollowAPI(){return Spicetify.Platform.FollowAPI}static get GraphQLLoader(){return Spicetify.Platform.GraphQLLoader}static get LibraryAPI(){return Spicetify.Platform.LibraryAPI}static get LocalFilesAPI(){return Spicetify.Platform.LocalFilesAPI}static get OfflineAPI(){return Spicetify.Platform.OfflineAPI}static get PlatformData(){return Spicetify.Platform.PlatformData}static get PlayerAPI(){return Spicetify.Platform.PlayerAPI}static get PlayHistoryAPI(){return Spicetify.Platform.PlayHistoryAPI}static get PlaylistAPI(){return Spicetify.Platform.PlaylistAPI}static get PlaylistPermissionsAPI(){return Spicetify.Platform.PlaylistPermissionsAPI}static get PrivateSessionAPI(){return Spicetify.Platform.PrivateSessionAPI}static get RadioStationAPI(){return Spicetify.Platform.RadioStationAPI}static get RecaptchaLoggerAPI(){return Spicetify.Platform.RecaptchaLoggerAPI}static get RecentlyPlayedAPI(){return Spicetify.Platform.RecentlyPlayedAPI}static get ReportAPI(){return Spicetify.Platform.ReportAPI}static get RootlistAPI(){return Spicetify.Platform.RootlistAPI}static get SegmentsAPI(){return Spicetify.Platform.SegmentsAPI}static get ShowAPI(){return Spicetify.Platform.ShowAPI}static get UpdateAPI(){return Spicetify.Platform.UpdateAPI}static get UserAPI(){return Spicetify.Platform.UserAPI}static get VideoAPI(){return Spicetify.Platform.VideoAPI}static get EnhanceAPI(){return Spicetify.Platform.EnhanceAPI}static get SEOExperiments(){return Spicetify.Platform.SEOExperiments}static get SingAlongAPI(){return Spicetify.Platform.SingAlongAPI}static get PlaybackAPI(){return Spicetify.Platform.PlaybackAPI}static get UBILogger(){return Spicetify.Platform.UBILogger}static get CollectionPlatformAPI(){return Spicetify.Platform.CollectionPlatformAPI}static get LocalStorageAPI(){return Spicetify.Platform.LocalStorageAPI}static get EqualizerAPI(){return Spicetify.Platform.EqualizerAPI}static get SoundtrapAPI(){return Spicetify.Platform.SoundtrapAPI}static get BuddyFeedAPI(){return Spicetify.Platform.BuddyFeedAPI}static get PanelAPI(){return Spicetify.Platform.PanelAPI}};e(r());function P(t,e,r){r="descending"===r?-1:1;return e<t?r:t<e?-1*r:0}var H=class{constructor(t,e,r){this.uri=t,this.name=e,this.image=r,this.artists=[],this.discs=new Map}getTracks(){const r=[];return this.discs.forEach((t,e)=>r.push(...t)),r}getDuration(){return this.getTracks().map(t=>t.duration).reduce((t,e)=>t+e)}},B=class{constructor(t,e){this.name=t,this.image=e,this.uri="spotify:local:"+t}},J=e(n()),{__extends:r,__values:f,__read:p,__spreadArray:h}=e(t(),1).default;function d(t){return"function"==typeof t}function V(t){t=t(function(t){Error.call(t),t.stack=(new Error).stack});return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t}var y=V(function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map(function(t,e){return e+1+") "+t.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}});function o(t,e){t&&0<=(e=t.indexOf(e))&&t.splice(e,1)}c.prototype.unsubscribe=function(){var e,t,r;if(!this.closed){this.closed=!0;var n=this._parentage;if(n)if(this._parentage=null,Array.isArray(n))try{for(var i=f(n),o=i.next();!o.done;o=i.next())o.value.remove(this)}catch(t){s={error:t}}finally{try{o&&!o.done&&(a=i.return)&&a.call(i)}finally{if(s)throw s.error}}else n.remove(this);var a=this.initialTeardown;if(d(a))try{a()}catch(t){r=t instanceof y?t.errors:[t]}var s=this._finalizers;if(s){this._finalizers=null;try{for(var c=f(s),l=c.next();!l.done;l=c.next()){var u=l.value;try{$(u)}catch(t){r=null!=r?r:[],t instanceof y?r=h(h([],p(r)),p(t.errors)):r.push(t)}}}catch(t){e={error:t}}finally{try{l&&!l.done&&(t=c.return)&&t.call(c)}finally{if(e)throw e.error}}}if(r)throw new y(r)}},c.prototype.add=function(t){var e;if(t&&t!==this)if(this.closed)$(t);else{if(t instanceof c){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!=(e=this._finalizers)?e:[]).push(t)}},c.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},c.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},c.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&o(e,t)},c.prototype.remove=function(t){var e=this._finalizers;e&&o(e,t),t instanceof c&&t._removeParent(this)},c.EMPTY=((n=new c).closed=!0,n);var a=c;function c(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}var G=a.EMPTY;function K(t){return t instanceof a||t&&"closed"in t&&d(t.remove)&&d(t.add)&&d(t.unsubscribe)}function $(t){d(t)?t():t.unsubscribe()}var l={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},u={setTimeout:function(t,e){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var i=u.delegate;return null!=i&&i.setTimeout?i.setTimeout.apply(i,h([t,e],p(r))):setTimeout.apply(void 0,h([t,e],p(r)))},clearTimeout:function(t){var e=u.delegate;return((null==e?void 0:e.clearTimeout)||clearTimeout)(t)},delegate:void 0};function Y(){}var q=m("C",void 0,void 0);function m(t,e,r){return{kind:t,value:e,error:r}}var b=null;function v(t){if(l.useDeprecatedSynchronousErrorHandling){var e=!b;if(e&&(b={errorThrown:!1,error:null}),t(),e){var e=b,r=e.errorThrown,e=e.error;if(b=null,r)throw e}}else t()}r(_,g=a),_.create=function(t,e,r){return new A(t,e,r)},_.prototype.next=function(t){this.isStopped?O(m("N",t,void 0),this):this._next(t)},_.prototype.error=function(t){this.isStopped?O(m("E",void 0,t),this):(this.isStopped=!0,this._error(t))},_.prototype.complete=function(){this.isStopped?O(q,this):(this.isStopped=!0,this._complete())},_.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,g.prototype.unsubscribe.call(this),this.destination=null)},_.prototype._next=function(t){this.destination.next(t)},_.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},_.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}};var g,Q=_;function _(t){var e=g.call(this)||this;return e.isStopped=!1,t?K(e.destination=t)&&t.add(e):e.destination=et,e}var W=Function.prototype.bind;function w(t,e){return W.call(t,e)}S.prototype.next=function(t){var e=this.partialObserver;if(e.next)try{e.next(t)}catch(t){I(t)}},S.prototype.error=function(t){var e=this.partialObserver;if(e.error)try{e.error(t)}catch(t){I(t)}else I(t)},S.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(t){I(t)}};var X=S;function S(t){this.partialObserver=t}r(tt,Z=Q);var Z,A=tt;function tt(t,e,r){var n=Z.call(this)||this;return r=d(t)||!t?{next:null!=t?t:void 0,error:null!=e?e:void 0,complete:null!=r?r:void 0}:n&&l.useDeprecatedNextContext?((e=Object.create(t)).unsubscribe=function(){return n.unsubscribe()},{next:t.next&&w(t.next,e),error:t.error&&w(t.error,e),complete:t.complete&&w(t.complete,e)}):t,n.destination=new X(r),n}function I(t){var e,r;l.useDeprecatedSynchronousErrorHandling?(r=t,l.useDeprecatedSynchronousErrorHandling&&b&&(b.errorThrown=!0,b.error=r)):(e=t,u.setTimeout(function(){var t=l.onUnhandledError;if(!t)throw e;t(e)}))}function O(t,e){var r=l.onStoppedNotification;r&&u.setTimeout(function(){return r(t,e)})}var et={closed:!0,next:Y,error:function(t){throw t},complete:Y},e="function"==typeof Symbol&&Symbol.observable||"@@observable";function rt(t){return t}x.prototype.lift=function(t){var e=new x;return e.source=this,e.operator=t,e},x.prototype.subscribe=function(t,e,r){var n,i=this,o=(n=t)&&n instanceof Q||function(t){return t&&d(t.next)&&d(t.error)&&d(t.complete)}(n)&&K(n)?t:new A(t,e,r);return v(function(){var t=i.operator,e=i.source;o.add(t?t.call(o,e):e?i._subscribe(o):i._trySubscribe(o))}),o},x.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},x.prototype.forEach=function(n,t){var i=this;return new(t=it(t))(function(t,e){var r=new A({next:function(t){try{n(t)}catch(t){e(t),r.unsubscribe()}},error:e,complete:t});i.subscribe(r)})},x.prototype._subscribe=function(t){var e;return null==(e=this.source)?void 0:e.subscribe(t)},x.prototype[e]=function(){return this},x.prototype.pipe=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return(0===(e=t).length?rt:1===e.length?e[0]:function(t){return e.reduce(function(t,e){return e(t)},t)})(this)},x.prototype.toPromise=function(t){var n=this;return new(t=it(t))(function(t,e){var r;n.subscribe(function(t){return r=t},function(t){return e(t)},function(){return t(r)})})},x.create=function(t){return new x(t)};var nt=x;function x(t){t&&(this._subscribe=t)}function it(t){return null!=(t=null!=t?t:l.Promise)?t:Promise}var j,ot=V(function(t){return function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),t=(r(E,j=nt),E.prototype.lift=function(t){var e=new st(this,this);return e.operator=t,e},E.prototype._throwIfClosed=function(){if(this.closed)throw new ot},E.prototype.next=function(i){var o=this;v(function(){var e,t;if(o._throwIfClosed(),!o.isStopped){o.currentObservers||(o.currentObservers=Array.from(o.observers));try{for(var r=f(o.currentObservers),n=r.next();!n.done;n=r.next())n.value.next(i)}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}}})},E.prototype.error=function(e){var r=this;v(function(){if(r._throwIfClosed(),!r.isStopped){r.hasError=r.isStopped=!0,r.thrownError=e;for(var t=r.observers;t.length;)t.shift().error(e)}})},E.prototype.complete=function(){var e=this;v(function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var t=e.observers;t.length;)t.shift().complete()}})},E.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(E.prototype,"observed",{get:function(){var t;return 0<(null==(t=this.observers)?void 0:t.length)},enumerable:!1,configurable:!0}),E.prototype._trySubscribe=function(t){return this._throwIfClosed(),j.prototype._trySubscribe.call(this,t)},E.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},E.prototype._innerSubscribe=function(t){var e=this,r=this.hasError,n=this.isStopped,i=this.observers;return r||n?G:(this.currentObservers=null,i.push(t),new a(function(){e.currentObservers=null,o(i,t)}))},E.prototype._checkFinalizedStatuses=function(t){var e=this.hasError,r=this.thrownError,n=this.isStopped;e?t.error(r):n&&t.complete()},E.prototype.asObservable=function(){var t=new nt;return t.source=this,t},E.create=function(t,e){return new st(t,e)},E);function E(){var t=j.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}r(k,at=t),k.prototype.next=function(t){var e,r;null!=(r=null==(e=this.destination)?void 0:e.next)&&r.call(e,t)},k.prototype.error=function(t){var e,r;null!=(r=null==(e=this.destination)?void 0:e.error)&&r.call(e,t)},k.prototype.complete=function(){var t,e;null!=(e=null==(t=this.destination)?void 0:t.complete)&&e.call(t)},k.prototype._subscribe=function(t){var e;return null!=(e=null==(e=this.source)?void 0:e.subscribe(t))?e:G};var at,st=k;function k(t,e){var r=at.call(this)||this;return r.destination=t,r.source=e,r}r(M,T=t),Object.defineProperty(M.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),M.prototype._subscribe=function(t){var e=T.prototype._subscribe.call(this,t);return e.closed||t.next(this._value),e},M.prototype.getValue=function(){var t=this.hasError,e=this.thrownError,r=this._value;if(t)throw e;return this._throwIfClosed(),r},M.prototype.next=function(t){T.prototype.next.call(this,this._value=t)};var T,C=M;function M(t){var e=T.call(this)||this;return e._value=t,e}var N="local-files:has-cache",z="local-files:merged-albums",ct=class{constructor(){this.isInitializedSubject=new C(!1),this.isInitializing=!1,this.isReady$=this.isInitializedSubject.asObservable(),this._tracks=new Map,this._albums=new Map,this._artists=new Map,this.processedAlbumsSubject=new C(0),this.processedAlbums$=this.processedAlbumsSubject.asObservable(),this.albumCountSubject=new C(0),this.albumCount$=this.albumCountSubject.asObservable()}get isReady(){return this.isInitializedSubject.value}get hasCache(){let t=localStorage.getItem(N);var e;return null===t&&(e=JSON.stringify(!0),localStorage.setItem(N,e),t=e),JSON.parse(t)}set hasCache(t){localStorage.setItem(N,JSON.stringify(t))}get cache(){let t=localStorage.getItem(z);var e;return null===t&&(e=JSON.stringify([]),localStorage.setItem(z,e),t=e),JSON.parse(t)}set cache(t){localStorage.setItem(z,JSON.stringify(t))}getTracks(){return this._tracks}getAlbums(){return this._albums}getArtists(){return this._artists}getArtistTracks(e){return Array.from(this._tracks.values()).filter(t=>t.artists.some(t=>t.uri===e)).sort((t,e)=>P(t.album.name,e.album.name,"ascending")||P(t.discNumber,e.discNumber,"ascending")||P(t.trackNumber,e.trackNumber,"ascending"))}getDisplayName(t){return""===t?"Untitled":t}albumKeyFromName(t){return"spotify:uri:"+t.toLowerCase().replace(/\s/g,"+")}async reset(){this.isInitializedSubject.next(!1),this.hasCache=!1,await this.init()}async init(){this.isReady||this.isInitializing||(this.isInitializing=!0,this._tracks=new Map,this._albums=new Map,this._artists=new Map,await this.processLocalTracks(),await this.postProcessAlbums(),this.isInitializedSubject.next(!0),this.isInitializing=!1)}async processLocalTracks(){for(const n of await i.LocalFilesAPI.getTracks()){let r;var t=this.getDisplayName(n.album.name),e=this.albumKeyFromName(t),t=(this._albums.has(e)?r=this._albums.get(e):(r=new H(e,t,n.album.images[0].url),this._albums.set(e,r)),n.artists.flatMap(t=>this.getArtistsFromString(t.name,r.image)));for(let e of t)this._artists.has(e.uri)||this._artists.set(e.uri,e),r.artists.some(t=>t.uri===e.uri)||r.artists.push(e);e={addedAt:n.addedAt,duration:n.duration.milliseconds,uri:n.uri,name:n.name,discNumber:n.discNumber,trackNumber:n.trackNumber,artists:t,album:r,localTrack:n};this._tracks.set(e.uri,e),r.discs.has(n.discNumber)||r.discs.set(n.discNumber,[]),null!=(t=r.discs.get(n.discNumber))&&t.push(e)}}async postProcessAlbums(){var t,e,r,n,i,o=this.hasCache,a=[],s=[],c=[];this.albumCountSubject.next(this._albums.size);let l=0;for([e,r]of this._albums.entries()){this.processedAlbumsSubject.next(l+1),l++;var u=await this.postProcessAlbum(e,r);if(!(u.length<=1)){s.push(e);for(var[f,p]of u.entries())if(0!==p.tracks.length){var h=p.tracks[0],f=this.albumKeyFromName(r.name+" "+f),d=new H(f,r.name,h.localTrack.album.images[0].url);for(let e of h.artists)d.artists.some(t=>t.uri===e.uri)||d.artists.push(e);for(const b of p.tracks)(b.album=d).discs.has(b.localTrack.discNumber)||d.discs.set(b.localTrack.discNumber,[]),null!=(t=d.discs.get(b.localTrack.discNumber))&&t.push(b);c.push(d)}a.push({uri:e,tracks:u.map(t=>t.tracks.map(t=>t.uri))})}}o||(this.cache=a,this.hasCache=!0);for(const v of s)this._albums.delete(v);for(const g of c)this._albums.set(g.uri,g);for([n,i]of this._albums.entries())for(var[y,m]of i.discs.entries())i.discs.set(y,m.sort((t,e)=>P(t.trackNumber,e.trackNumber,"ascending")))}async postProcessAlbum(e,t){var r,n=this.hasCache,i=this.cache;let o=[];if(n){n=i.find(t=>t.uri===e);void 0!==n&&(o=n.tracks.map(t=>({cover:null,tracks:t.filter(t=>this._tracks.has(t)).map(t=>this._tracks.get(t))})))}else{if(t.artists.length<=1)return[];i=t.getTracks();if(i.length<=1)return[];var a,s,c=new Map;for(const f of i){var l=f.artists.map(t=>t.name).join(", ");c.has(l)?null!=(r=c.get(l))&&r.push(f):c.set(l,[f])}if(1===c.size)return[];for([a,s]of c.entries()){var u=s[0].localTrack.album.images[0].url,u=await this.getImage(u);const p=this.getImageDataFromCanvas(u);u=o.find(t=>0===this.getImageDifferenceWithPixelMatch(t.cover,p));void 0===u?o.push({tracks:s,cover:p}):u.tracks.push(...s)}}return o}getArtistsFromString(t,e){return t.split(/(?:,|;)/).map(t=>new B(this.getDisplayName(t.trim()),e))}async getImage(n){return new Promise((t,e)=>{const r=new Image;r.onload=()=>{t(r)},r.onerror=t=>{console.error(`Couldn't load image "${n}"`,t),e(t)},r.src=n})}getImageDataFromCanvas(t){var e=document.createElement("canvas"),e=(e.width=50,e.height=50,e.style.width="50px",e.style.height="50px",e.getContext("2d"));return e.drawImage(t,0,0,t.width,t.height,0,0,50,50),e.getImageData(0,0,50,50)}getImageDifferenceWithPixelMatch(t,e){return(0,J.default)(t.data,e.data,null,t.width,t.height,{threshold:.1})}};(async()=>{for(window.localTracksService=new ct;null==Spicetify||!Spicetify.Platform;)await new Promise(t=>setTimeout(t,100));const e=new Spicetify.Menu.Item("Rebuild local album cache",!1,()=>window.localTracksService.reset()),r=t=>{t.includes("better-local-files")?e.register():e.deregister()};r(i.History.location.pathname),i.History.listen(t=>{r(t.pathname)})})()})();