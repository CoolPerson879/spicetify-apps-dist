"use strict";var eternalDjukebox=(()=>{var t,e,A=Object.create,I=Object.defineProperty,M=Object.getOwnPropertyDescriptor,q=Object.getOwnPropertyNames,F=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty,r=(t=>"undefined"!=typeof require?require:"undefined"!=typeof Proxy?new Proxy(t,{get:(t,e)=>("undefined"!=typeof require?require:t)[e]}):t)(function(t){if("react"===t)return Spicetify.React;if("react-dom"===t)return Spicetify.ReactDOM;if("undefined"!=typeof require)return require.apply(this,arguments);throw new Error('Dynamic require of "'+t+'" is not supported')}),n=(t,e,r)=>{r=null!=t?A(F(t)):{};var n=!e&&t&&t.__esModule?r:I(r,"default",{value:t,enumerable:!0}),i=t,s=void 0,o=void 0;if(i&&"object"==typeof i||"function"==typeof i)for(let t of q(i))z.call(n,t)||t===s||I(n,t,{get:()=>i[t],enumerable:!(o=M(i,t))||o.enumerable});return n},$=(t={"node_modules/tslib/tslib.js"(t,n){var e,r,s,o,a,c,u,l,h,f,p,d,b,y,v,g,m,w,S,x,_,B,P,O,j;!function(e){var i="object"==typeof global?global:"object"==typeof self?self:"object"==typeof this?this:{};function r(r,n){return r!==i&&("function"==typeof Object.create?Object.defineProperty(r,"__esModule",{value:!0}):r.__esModule=!0),function(t,e){return r[t]=n?n(t,e):e}}"function"==typeof define&&define.amd?define("tslib",["exports"],function(t){e(r(i,r(t)))}):"object"==typeof n&&"object"==typeof n.exports?e(r(i,r(n.exports))):e(r(i))}(function(t){var n=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,e){t.__proto__=e}:function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}),i=(e=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},r=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},s=function(t,e){var r={};for(i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(r[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var n=0,i=Object.getOwnPropertySymbols(t);n<i.length;n++)e.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(t,i[n])&&(r[i[n]]=t[i[n]]);return r},o=function(t,e,r,n){var i,s=arguments.length,o=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;0<=a;a--)(i=t[a])&&(o=(s<3?i(o):3<s?i(e,r,o):i(e,r))||o);return 3<s&&o&&Object.defineProperty(e,r,o),o},a=function(r,n){return function(t,e){n(t,e,r)}},c=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},u=function(t,o,a,c){return new(a=a||Promise)(function(r,e){function n(t){try{s(c.next(t))}catch(t){e(t)}}function i(t){try{s(c.throw(t))}catch(t){e(t)}}function s(t){var e;t.done?r(t.value):((e=t.value)instanceof a?e:new a(function(t){t(e)})).then(n,i)}s((c=c.apply(t,o||[])).next())})},l=function(n,i){var s,o,a,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},u={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function t(r){return function(t){var e=[r,t];if(s)throw new TypeError("Generator is already executing.");for(;c=u&&e[u=0]?0:c;)try{if(s=1,o&&(a=2&e[0]?o.return:e[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,e[1])).done)return a;switch(o=0,(e=a?[2&e[0],a.value]:e)[0]){case 0:case 1:a=e;break;case 4:return c.label++,{value:e[1],done:!1};case 5:c.label++,o=e[1],e=[0];continue;case 7:e=c.ops.pop(),c.trys.pop();continue;default:if(!(a=0<(a=c.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){c=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3]))c.label=e[1];else if(6===e[0]&&c.label<a[1])c.label=a[1],a=e;else{if(!(a&&c.label<a[2])){a[2]&&c.ops.pop(),c.trys.pop();continue}c.label=a[2],c.ops.push(e)}}e=i.call(n,c)}catch(t){e=[6,t],o=0}finally{s=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}}},h=function(t,e){for(var r in t)"default"===r||Object.prototype.hasOwnProperty.call(e,r)||j(e,t,r)},j=Object.create?function(t,e,r,n){void 0===n&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);i&&("get"in i?e.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}:function(t,e,r,n){t[n=void 0===n?r:n]=e[r]},f=function(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return{value:(t=t&&n>=t.length?void 0:t)&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},p=function(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,i,s=r.call(t),o=[];try{for(;(void 0===e||0<e--)&&!(n=s.next()).done;)o.push(n.value)}catch(t){i={error:t}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},d=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(p(arguments[e]));return t},b=function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;for(var n=Array(t),i=0,e=0;e<r;e++)for(var s=arguments[e],o=0,a=s.length;o<a;o++,i++)n[i]=s[o];return n},y=function(t,e,r){if(r||2===arguments.length)for(var n,i=0,s=e.length;i<s;i++)!n&&i in e||((n=n||Array.prototype.slice.call(e,0,i))[i]=e[i]);return t.concat(n||Array.prototype.slice.call(e))},v=function(t){return this instanceof v?(this.v=t,this):new v(t)},g=function(t,e,r){var i,s,o;if(Symbol.asyncIterator)return i=r.apply(t,e||[]),s=[],o={},n("next"),n("throw"),n("return"),o[Symbol.asyncIterator]=function(){return this},o;throw new TypeError("Symbol.asyncIterator is not defined.");function n(n){i[n]&&(o[n]=function(r){return new Promise(function(t,e){1<s.push([n,r,t,e])||a(n,r)})})}function a(t,e){try{(r=i[t](e)).value instanceof v?Promise.resolve(r.value.v).then(c,u):l(s[0][2],r)}catch(t){l(s[0][3],t)}var r}function c(t){a("next",t)}function u(t){a("throw",t)}function l(t,e){t(e),s.shift(),s.length&&a(s[0][0],s[0][1])}},m=function(n){var i,t={};return e("next"),e("throw",function(t){throw t}),e("return"),t[Symbol.iterator]=function(){return this},t;function e(e,r){t[e]=n[e]?function(t){return(i=!i)?{value:v(n[e](t)),done:"return"===e}:r?r(t):t}:r}},w=function(o){var t,e;if(Symbol.asyncIterator)return(t=o[Symbol.asyncIterator])?t.call(o):(o=f(o),e={},r("next"),r("throw"),r("return"),e[Symbol.asyncIterator]=function(){return this},e);throw new TypeError("Symbol.asyncIterator is not defined.");function r(s){e[s]=o[s]&&function(i){return new Promise(function(t,e){var r,n;i=o[s](i),r=t,t=e,n=i.done,e=i.value,Promise.resolve(e).then(function(t){r({value:t,done:n})},t)})}}},S=function(t,e){return Object.defineProperty?Object.defineProperty(t,"raw",{value:e}):t.raw=e,t},Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e});x=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)"default"!==r&&Object.prototype.hasOwnProperty.call(t,r)&&j(e,t,r);return i(e,t),e},_=function(t){return t&&t.__esModule?t:{default:t}},B=function(t,e,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t===e&&n:e.has(t))return"m"===r?n:"a"===r?n.call(t):n?n.value:e.get(t);throw new TypeError("Cannot read private member from an object whose class did not declare it")},P=function(t,e,r,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t===e&&i:e.has(t))return"a"===n?i.call(t,r):i?i.value=r:e.set(t,r),r;throw new TypeError("Cannot write private member to an object whose class did not declare it")},O=function(t,e){if(null===e||"object"!=typeof e&&"function"!=typeof e)throw new TypeError("Cannot use 'in' operator on non-object");return"function"==typeof t?e===t:t.has(e)},t("__extends",e),t("__assign",r),t("__rest",s),t("__decorate",o),t("__param",a),t("__metadata",c),t("__awaiter",u),t("__generator",l),t("__exportStar",h),t("__createBinding",j),t("__values",f),t("__read",p),t("__spread",d),t("__spreadArrays",b),t("__spreadArray",y),t("__await",v),t("__asyncGenerator",g),t("__asyncDelegator",m),t("__asyncValues",w),t("__makeTemplateObject",S),t("__importStar",x),t("__importDefault",_),t("__classPrivateFieldGet",B),t("__classPrivateFieldSet",P),t("__classPrivateFieldIn",O)})}},function(){return e||(0,t[q(t)[0]])((e={exports:{}}).exports,e),e.exports});n(r("react"));var o,U,G=n(r("react")),i=n(r("react")),a=r("react"),K={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"},Q=(o="Infinity",U=[["path",{d:"M18.178 8c5.096 0 5.096 8 0 8-5.095 0-7.133-8-12.739-8-4.585 0-4.585 8 0 8 5.606 0 7.644-8 12.74-8z",key:"13d65y"}]],(r=(0,a.forwardRef)(({color:t="currentColor",size:e=24,strokeWidth:r=2,children:n,...i},s)=>(0,a.createElement)("svg",{ref:s,...K,width:e,height:e,stroke:t,strokeWidth:r,className:"lucide lucide-"+o.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),...i},[...U.map(([t,e])=>(0,a.createElement)(t,e)),...(Array.isArray(n)?n:[n])||[]]))).displayName=""+o,r),H=class extends i.default.Component{constructor(t){super(t),this.state={isActive:!1}}render(){return i.default.createElement(Spicetify.ReactComponent.TooltipWrapper,{label:"Enable jukebox",showDelay:100,renderInline:!1},i.default.createElement("button",{className:"main-repeatButton-button "+(this.state.isActive?"main-repeatButton-active":""),role:"checkbox","aria-checked":"false","aria-label":"Activer jukebox",onClick:()=>this.toggleJukebox()},i.default.createElement(Q,{size:24})))}toggleJukebox(){window.jukebox.isEnabled=!window.jukebox.isEnabled,this.setState(t=>({isActive:!t.isActive}))}},V=class{constructor(t){this.analysis={bars:t.bars,beats:t.beats,sections:t.sections,segments:t.segments,tatums:t.tatums}}remixTrack(){return this.preprocessTrack()}preprocessTrack(){for(const n of["sections","bars","beats","tatums","segments"]){var t,e,r=this.analysis[n];for([t,e]of r.entries())0<(e.index=t)?e.prev=r[t-1]:e.prev=null,t<r.length-1?e.next=r[t+1]:e.next=null}return this.connectQuanta(this.analysis.sections,this.analysis.bars),this.connectQuanta(this.analysis.bars,this.analysis.beats),this.connectQuanta(this.analysis.beats,this.analysis.tatums),this.connectQuanta(this.analysis.tatums,this.analysis.segments),this.connectFirstOverlappingSegment(this.analysis,this.analysis.bars),this.connectFirstOverlappingSegment(this.analysis,this.analysis.beats),this.connectFirstOverlappingSegment(this.analysis,this.analysis.tatums),this.connectAllOverlappingSegments(this.analysis,this.analysis.bars),this.connectAllOverlappingSegments(this.analysis,this.analysis.beats),this.connectAllOverlappingSegments(this.analysis,this.analysis.tatums),this.analysis}connectQuanta(t,e){let r=0;for(const s of t){s.children=[];for(var n=r;n<e.length;n++){var i=e[n];if(i.start>=s.start&&i.start<s.start+s.duration)i.parent=s,i.indexInParent=s.children.length,s.children.push(i),r=n;else if(i.start>s.start)break}}}connectFirstOverlappingSegment(t,e){let r=0;var n,i=t.segments;for(n of e)for(var s=r;s<i.length;s++){var o=i[s];if(o.start>=n.start){n.firstOverlappingSegment=o,r=s;break}}}connectAllOverlappingSegments(t,e){let r=0;var n=t.segments;for(const o of e){o.overlappingSegments=[];for(var i=r;i<n.length;i++){var s=n[i];if(!(s.start+s.duration<o.start)){if(s.start>o.start+o.duration)break;r=i,o.overlappingSegments.push(s)}}}}},W=class{constructor(t,e,r){this.beatsPlayed=0,this.startTime=0,this.currentRandomBranchChance=0,this.track=t,this.analysis=e,this.graph=r,this.currentRandomBranchChance=window.jukebox.settings.minRandomBranchChance,this.startTime=(new Date).getTime()}},{__extends:r,__awaiter:Y,__generator:J,__values:h,__read:f,__spreadArray:p,__await:s,__asyncGenerator:Z,__asyncValues:X}=n($(),1).default;function d(t){return"function"==typeof t}function tt(t){t=t(function(t){Error.call(t),t.stack=(new Error).stack});return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t}var b=tt(function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map(function(t,e){return e+1+") "+t.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}});function c(t,e){t&&0<=(e=t.indexOf(e))&&t.splice(e,1)}l.prototype.unsubscribe=function(){var e,t,r;if(!this.closed){this.closed=!0;var n=this._parentage;if(n)if(this._parentage=null,Array.isArray(n))try{for(var i=h(n),s=i.next();!s.done;s=i.next())s.value.remove(this)}catch(t){a={error:t}}finally{try{s&&!s.done&&(o=i.return)&&o.call(i)}finally{if(a)throw a.error}}else n.remove(this);var o=this.initialTeardown;if(d(o))try{o()}catch(t){r=t instanceof b?t.errors:[t]}var a=this._finalizers;if(a){this._finalizers=null;try{for(var c=h(a),u=c.next();!u.done;u=c.next()){var l=u.value;try{nt(l)}catch(t){r=null!=r?r:[],t instanceof b?r=p(p([],f(r)),f(t.errors)):r.push(t)}}}catch(t){e={error:t}}finally{try{u&&!u.done&&(t=c.return)&&t.call(c)}finally{if(e)throw e.error}}}if(r)throw new b(r)}},l.prototype.add=function(t){var e;if(t&&t!==this)if(this.closed)nt(t);else{if(t instanceof l){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!=(e=this._finalizers)?e:[]).push(t)}},l.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},l.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},l.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&c(e,t)},l.prototype.remove=function(t){var e=this._finalizers;e&&c(e,t),t instanceof l&&t._removeParent(this)},l.EMPTY=((n=new l).closed=!0,n);var u=l;function l(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}var et=u.EMPTY;function rt(t){return t instanceof u||t&&"closed"in t&&d(t.remove)&&d(t.add)&&d(t.unsubscribe)}function nt(t){d(t)?t():t.unsubscribe()}var y={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},v={setTimeout:function(t,e){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var i=v.delegate;return null!=i&&i.setTimeout?i.setTimeout.apply(i,p([t,e],f(r))):setTimeout.apply(void 0,p([t,e],f(r)))},clearTimeout:function(t){var e=v.delegate;return((null==e?void 0:e.clearTimeout)||clearTimeout)(t)},delegate:void 0};function it(e){v.setTimeout(function(){var t=y.onUnhandledError;if(!t)throw e;t(e)})}function st(){}var ot=g("C",void 0,void 0);function g(t,e,r){return{kind:t,value:e,error:r}}var m=null;function w(t){if(y.useDeprecatedSynchronousErrorHandling){var e=!m;if(e&&(m={errorThrown:!1,error:null}),t(),e){var e=m,r=e.errorThrown,e=e.error;if(m=null,r)throw e}}else t()}r(_,S=u),_.create=function(t,e,r){return new ht(t,e,r)},_.prototype.next=function(t){this.isStopped?pt(g("N",t,void 0),this):this._next(t)},_.prototype.error=function(t){this.isStopped?pt(g("E",void 0,t),this):(this.isStopped=!0,this._error(t))},_.prototype.complete=function(){this.isStopped?pt(ot,this):(this.isStopped=!0,this._complete())},_.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,S.prototype.unsubscribe.call(this),this.destination=null)},_.prototype._next=function(t){this.destination.next(t)},_.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},_.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}};var S,x=_;function _(t){var e=S.call(this)||this;return e.isStopped=!1,t?rt(e.destination=t)&&t.add(e):e.destination=dt,e}var at=Function.prototype.bind;function ct(t,e){return at.call(t,e)}B.prototype.next=function(t){var e=this.partialObserver;if(e.next)try{e.next(t)}catch(t){P(t)}},B.prototype.error=function(t){var e=this.partialObserver;if(e.error)try{e.error(t)}catch(t){P(t)}else P(t)},B.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(t){P(t)}};var ut=B;function B(t){this.partialObserver=t}r(ft,lt=x);var lt,ht=ft;function ft(t,e,r){var n=lt.call(this)||this;return r=d(t)||!t?{next:null!=t?t:void 0,error:null!=e?e:void 0,complete:null!=r?r:void 0}:n&&y.useDeprecatedNextContext?((e=Object.create(t)).unsubscribe=function(){return n.unsubscribe()},{next:t.next&&ct(t.next,e),error:t.error&&ct(t.error,e),complete:t.complete&&ct(t.complete,e)}):t,n.destination=new ut(r),n}function P(t){var e;y.useDeprecatedSynchronousErrorHandling?(e=t,y.useDeprecatedSynchronousErrorHandling&&m&&(m.errorThrown=!0,m.error=e)):it(t)}function pt(t,e){var r=y.onStoppedNotification;r&&v.setTimeout(function(){return r(t,e)})}var dt={closed:!0,next:st,error:function(t){throw t},complete:st},bt="function"==typeof Symbol&&Symbol.observable||"@@observable";function yt(t){return t}j.prototype.lift=function(t){var e=new j;return e.source=this,e.operator=t,e},j.prototype.subscribe=function(t,e,r){var n,i=this,s=(n=t)&&n instanceof x||function(t){return t&&d(t.next)&&d(t.error)&&d(t.complete)}(n)&&rt(n)?t:new ht(t,e,r);return w(function(){var t=i.operator,e=i.source;s.add(t?t.call(s,e):e?i._subscribe(s):i._trySubscribe(s))}),s},j.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},j.prototype.forEach=function(n,t){var i=this;return new(t=vt(t))(function(t,e){var r=new ht({next:function(t){try{n(t)}catch(t){e(t),r.unsubscribe()}},error:e,complete:t});i.subscribe(r)})},j.prototype._subscribe=function(t){var e;return null==(e=this.source)?void 0:e.subscribe(t)},j.prototype[bt]=function(){return this},j.prototype.pipe=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return(0===(e=t).length?yt:1===e.length?e[0]:function(t){return e.reduce(function(t,e){return e(t)},t)})(this)},j.prototype.toPromise=function(t){var n=this;return new(t=vt(t))(function(t,e){var r;n.subscribe(function(t){return r=t},function(t){return e(t)},function(){return t(r)})})},j.create=function(t){return new j(t)};var O=j;function j(t){t&&(this._subscribe=t)}function vt(t){return null!=(t=null!=t?t:y.Promise)?t:Promise}function gt(r){return function(t){if(d(null==(e=t)?void 0:e.lift))return t.lift(function(t){try{return r(t,this)}catch(t){this.error(t)}});var e;throw new TypeError("Unable to lift unknown Observable type")}}function E(t,e,r,n,i){return new mt(t,e,r,n,i)}r(wt,C=x),wt.prototype.unsubscribe=function(){var t;this.shouldUnsubscribe&&!this.shouldUnsubscribe()||(t=this.closed,C.prototype.unsubscribe.call(this),t)||null==(t=this.onFinalize)||t.call(this)};var C,mt=wt;function wt(e,r,t,n,i,s){var o=C.call(this,e)||this;return o.onFinalize=i,o.shouldUnsubscribe=s,o._next=r?function(t){try{r(t)}catch(t){e.error(t)}}:C.prototype._next,o._error=n?function(t){try{n(t)}catch(t){e.error(t)}finally{this.unsubscribe()}}:C.prototype._error,o._complete=t?function(){try{t()}catch(t){e.error(t)}finally{this.unsubscribe()}}:C.prototype._complete,o}var St,xt=tt(function(t){return function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),k=(r(D,St=O),D.prototype.lift=function(t){var e=new Bt(this,this);return e.operator=t,e},D.prototype._throwIfClosed=function(){if(this.closed)throw new xt},D.prototype.next=function(i){var s=this;w(function(){var e,t;if(s._throwIfClosed(),!s.isStopped){s.currentObservers||(s.currentObservers=Array.from(s.observers));try{for(var r=h(s.currentObservers),n=r.next();!n.done;n=r.next())n.value.next(i)}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}}})},D.prototype.error=function(e){var r=this;w(function(){if(r._throwIfClosed(),!r.isStopped){r.hasError=r.isStopped=!0,r.thrownError=e;for(var t=r.observers;t.length;)t.shift().error(e)}})},D.prototype.complete=function(){var e=this;w(function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var t=e.observers;t.length;)t.shift().complete()}})},D.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(D.prototype,"observed",{get:function(){var t;return 0<(null==(t=this.observers)?void 0:t.length)},enumerable:!1,configurable:!0}),D.prototype._trySubscribe=function(t){return this._throwIfClosed(),St.prototype._trySubscribe.call(this,t)},D.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},D.prototype._innerSubscribe=function(t){var e=this,r=this.hasError,n=this.isStopped,i=this.observers;return r||n?et:(this.currentObservers=null,i.push(t),new u(function(){e.currentObservers=null,c(i,t)}))},D.prototype._checkFinalizedStatuses=function(t){var e=this.hasError,r=this.thrownError,n=this.isStopped;e?t.error(r):n&&t.complete()},D.prototype.asObservable=function(){var t=new O;return t.source=this,t},D.create=function(t,e){return new Bt(t,e)},D);function D(){var t=St.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}r(N,_t=k),N.prototype.next=function(t){var e,r;null!=(r=null==(e=this.destination)?void 0:e.next)&&r.call(e,t)},N.prototype.error=function(t){var e,r;null!=(r=null==(e=this.destination)?void 0:e.error)&&r.call(e,t)},N.prototype.complete=function(){var t,e;null!=(e=null==(t=this.destination)?void 0:t.complete)&&e.call(t)},N.prototype._subscribe=function(t){var e;return null!=(e=null==(e=this.source)?void 0:e.subscribe(t))?e:et};var _t,Bt=N;function N(t,e){var r=_t.call(this)||this;return r.destination=t,r.source=e,r}r(T,R=k),Object.defineProperty(T.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),T.prototype._subscribe=function(t){var e=R.prototype._subscribe.call(this,t);return e.closed||t.next(this._value),e},T.prototype.getValue=function(){var t=this.hasError,e=this.thrownError,r=this._value;if(t)throw e;return this._throwIfClosed(),r},T.prototype.next=function(t){R.prototype.next.call(this,this._value=t)};var R,Pt=T;function T(t){var e=R.call(this)||this;return e._value=t,e}var Ot=function(t){return t&&"number"==typeof t.length&&"function"!=typeof t};var jt="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function Et(t){if(t instanceof O)return t;if(null!=t){if(d(t[bt]))return i=t,new O(function(t){var e=i[bt]();if(d(e.subscribe))return e.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")});if(Ot(t))return n=t,new O(function(t){for(var e=0;e<n.length&&!t.closed;e++)t.next(n[e]);t.complete()});if(d(null==(e=t)?void 0:e.then))return r=t,new O(function(e){r.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,it)});if(e=t,Symbol.asyncIterator&&d(null==e?void 0:e[Symbol.asyncIterator]))return Ct(t);if(d(null==(e=t)?void 0:e[jt]))return o=t,new O(function(t){var e,r;try{for(var n=h(o),i=n.next();!i.done;i=n.next()){var s=i.value;if(t.next(s),t.closed)return}}catch(t){e={error:t}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(e)throw e.error}}t.complete()});if(d(null==(e=t)?void 0:e.getReader))return Ct(function(i){return Z(this,arguments,function(){var e,r,n;return J(this,function(t){switch(t.label){case 0:e=i.getReader(),t.label=1;case 1:t.trys.push([1,,9,10]),t.label=2;case 2:return[4,s(e.read())];case 3:return(r=t.sent(),n=r.value,r.done)?[4,s(void 0)]:[3,5];case 4:return[2,t.sent()];case 5:return[4,s(n)];case 6:return[4,t.sent()];case 7:return t.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}(t))}var o,r,n,i,e;throw e=t,new TypeError("You provided "+(null!==e&&"object"==typeof e?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Ct(t){return new O(function(e){!function(r,n){var i,s,o,a;return Y(this,void 0,void 0,function(){var e;return J(this,function(t){switch(t.label){case 0:t.trys.push([0,5,6,11]),i=X(r),t.label=1;case 1:return[4,i.next()];case 2:if((s=t.sent()).done)return[3,4];if(e=s.value,n.next(e),n.closed)return[2];t.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return e=t.sent(),o={error:e},[3,11];case 6:return(t.trys.push([6,,9,10]),s&&!s.done&&(a=i.return))?[4,a.call(i)]:[3,8];case 7:t.sent(),t.label=8;case 8:return[3,10];case 9:if(o)throw o.error;return[7];case 10:return[7];case 11:return n.complete(),[2]}})})}(t,e).catch(function(t){return e.error(t)})})}function kt(n,i){return gt(function(t,e){var r=0;t.subscribe(E(e,function(t){e.next(n.call(i,t,r++))}))})}var Dt=Array.isArray;function Nt(r){return kt(function(t){return e=r,Dt(t=t)?e.apply(void 0,p([],f(t))):e(t);var e})}function Rt(t,o,r,n,i,s,a,e){var c=[],u=0,l=0,h=function(){c.length||u||o.complete()},f=function(t){return u<n?p(t):c.push(t)},p=function(t){s&&o.next(t),u++;var e=!1;Et(r(t,l++)).subscribe(E(o,function(t){null!=i&&i(t),s?f(t):o.next(t)},function(){e=!0},void 0,function(){if(e)try{u--;for(;c.length&&u<n;)!function(){var t,e,r,n,i,s=c.shift();a?(t=o,r=function(){p(s)},void 0===n&&(n=0),void 0===i&&(i=!1),e=(e=a).schedule(function(){r(),i?t.add(this.schedule(null,n)):this.unsubscribe()},n),t.add(e)):p(s)}();h()}catch(t){o.error(t)}}))};return t.subscribe(E(o,f,function(){h()})),function(){null!=e&&e()}}var Tt=["addListener","removeListener"],Lt=["addEventListener","removeEventListener"],At=["on","off"];function L(r,n,i,t){if(d(i)&&(t=i,i=void 0),t)return L(r,n,i).pipe(Nt(t));var t=f(d((t=r).addEventListener)&&d(t.removeEventListener)?Lt.map(function(e){return function(t){return r[e](n,t,i)}}):d((t=r).addListener)&&d(t.removeListener)?Tt.map(It(r,n)):d((t=r).on)&&d(t.off)?At.map(It(r,n)):[],2),e=t[0],s=t[1];if(!e&&Ot(r))return function t(i,s,r){return void 0===r&&(r=1/0),d(s)?t(function(r,n){return kt(function(t,e){return s(r,t,n,e)})(Et(i(r,n)))},r):("number"==typeof s&&(r=s),gt(function(t,e){return Rt(t,e,i,r)}))}(function(t){return L(t,n,i)})(Et(r));if(e)return new O(function(r){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return r.next(1<t.length?t:t[0])}return e(t),function(){return s(t)}});throw new TypeError("Invalid event target")}function It(r,n){return function(e){return function(t){return r[e](n,t)}}}function Mt(t,e){return t===e}var qt=class{constructor(){this.maxBranches=4,this.maxBranchDistance=80,this.addLastEdge=!0,this.justBackwards=!1,this.justLongBranches=!1,this.removeSequentialBranches=!1,this.minRandomBranchChance=0,this.maxRandomBranchChance=0,this.randomBranchChanceDelta=0,this.minBeatsBeforeBranching=5,this.defaultMinRandomBranchChance=.18,this.defaultMaxRandomBranchChance=.5,this.defaultRandomBranchChanceDelta=.018,this.minRandomBranchChanceDelta=0,this.maxRandomBranchChanceDelta=.2,this.minRandomBranchChance=this.defaultMinRandomBranchChance,this.maxRandomBranchChance=this.defaultMaxRandomBranchChance,this.randomBranchChanceDelta=this.defaultRandomBranchChanceDelta}},Ft=class{constructor(t=[]){this.beats=[],this.lastBranchPoint=0,this.longestReach=0,this.beats=t}},zt=class{get id(){return this.source.index+"-"+this.destination.index}constructor(t,e,r){this.source=t,this.destination=e,this.distance=r,this.isPlaying=!1,this.deleted=!1}},$t=class{constructor(t,e,r){this.isPlaying=!1,this.next=null,this.previous=null,this.neighbours=[],this.playCount=0,this.index=t,this.start=e,this.duration=r}get end(){return this.start+this.duration}},Ut=class{constructor(t,e){this.settings=t,this.beats=e,this.allEdges=[],this.allNeighbours=[],this.minLongBranch=0,this.computedMaxBranchDistance=0,this.currentMaxBranchDistance=0,this.graph=new Ft,this.allNeighbours=e.map(()=>[]),this.minLongBranch=e.length/5}generateGraph(){var t,e,r=this.beats.map(t=>new $t(t.index,t.start,t.duration));for([t,e]of r.entries())t<r.length-1&&(e.next=r[t+1]),t<0&&(e.previous=r[t-1]);return this.graph=new Ft(r),this.precalculateNearestNeighbors(),0==this.currentMaxBranchDistance?this.dynamicCollectNearestNeighbors():this.collectNearestNeighbors(this.currentMaxBranchDistance),this.postProcessNearestNeighbors(),this.graph}dynamicCollectNearestNeighbors(){var e=this.beats.length/6;for(let t=10;t<this.settings.maxBranchDistance&&!(e<=this.collectNearestNeighbors(t));t+=5);this.currentMaxBranchDistance=0,this.computedMaxBranchDistance=0}precalculateNearestNeighbors(){if(0===this.allEdges.length)for(const t of this.beats)this.calculateNearestNeighborsForBeat(t)}calculateNearestNeighborsForBeat(r){var t,n,e=this.settings.maxBranches,i=this.settings.maxBranchDistance,s=[];for([t,n]of this.beats.entries())if(t!==r.index){let e=0;for(var[o,a]of r.overlappingSegments.entries()){let t=100;o<n.overlappingSegments.length&&(o=n.overlappingSegments[o],t=a.index===o.index?100:this.getSegmentsDistance(a,o)),e+=t}var c=r.indexInParent===n.indexInParent?0:100,c=e/r.overlappingSegments.length+c;c<i&&(c=new zt(this.graph.beats[r.index],this.graph.beats[t],c),s.push(c))}s.sort((t,e)=>t.distance>e.distance?1:e.distance>t.distance?-1:0);for(let t=0;t<e&&t<s.length;t++){var u=s[t];this.allNeighbours[r.index].push(u),this.allEdges.push(u)}}getSegmentsDistance(t,e){return+this.getEuclideanDistance(t.timbre,e.timbre)+10*this.getEuclideanDistance(t.pitches,e.pitches)+ +Math.abs(t.loudness_start-e.loudness_start)+ +Math.abs(t.loudness_max-e.loudness_max)+100*Math.abs(t.duration-e.duration)+ +Math.abs(t.confidence-e.confidence)}getEuclideanDistance(e,r){let n=0;for(let t=0;t<e.length;t++){var i=r[t]-e[t];n+=i*i}return Math.sqrt(n)}collectNearestNeighbors(t){let e=0;for(var[r,n]of this.graph.beats.entries())n.neighbours=this.filterNearestNeighbors(r,t),0<n.neighbours.length&&(e+=1);return e}filterNearestNeighbors(e,r){return this.allNeighbours[e].filter(t=>!t.deleted&&!(this.settings.justBackwards&&t.destination.index>e||this.settings.justLongBranches&&Math.abs(t.destination.index-e)<this.minLongBranch)&&t.distance<=r)}postProcessNearestNeighbors(){this.settings.addLastEdge&&this.insertBestBackwardBranch(this.currentMaxBranchDistance,this.longestBackwardBranch()<50?65:55),this.graph.lastBranchPoint=this.findBestLastBeat(),this.filterOutBadBranches(),this.settings.removeSequentialBranches&&this.filterOutSequentialBranches()}longestBackwardBranch(){let t=0;for(var e of this.graph.beats)for(var r of e.neighbours){r=e.index-r.destination.index;r>t&&(t=r)}return 100*t/this.beats.length}insertBestBackwardBranch(t,e){var r,n,i,s,o=[];for([r,n]of this.graph.beats.entries())for(const l of this.allNeighbours[r]){var a=l.destination.index,c=l.distance,u=r-a;0<u&&c<e&&(c=100*u/this.graph.beats.length,o.push({percentDistance:c,beatIndex:r,otherBeatIndex:a,currentBeat:n,edge:l}))}0!==o.length&&(o.sort((t,e)=>t.percentDistance-e.percentDistance),o.reverse(),s=(i=o[0]).currentBeat,t<(t=i.edge).distance)&&s.neighbours.push(t)}calculateReachability(){var t,e,r=this.graph.beats.map(t=>0);for([t,e]of this.graph.beats.entries())r[t]=this.graph.beats.length-t;for(let t=0;t<1e3;t++){let t=0;for(var[n,i]of this.graph.beats.entries()){var s=!1;for(const c of i.neighbours){var o=r[c.destination.index];o>r[n]&&(r[n]=o,s=!0)}if(n<this.graph.beats.length-1&&(i=r[n+1])>r[n]&&(r[n]=i,s=!0),s){t++;for(var a=0;a<n;a++)r[a]<r[n]&&(r[a]=r[n])}}if(0==t)break}return r}findBestLastBeat(){var e=this.calculateReachability();let r=0,n=0;for(let t=this.graph.beats.length-1;0<=t;t--){var i=this.graph.beats[t],s=this.graph.beats.length-t,s=100*(e[t]-s)/this.beats.length;if(s>n&&0<i.neighbours.length&&(n=s,r=t,50<=s))break}return this.graph.longestReach=n,r}filterOutBadBranches(){const e=this.graph.lastBranchPoint;for(let t=0;t<e;t++){var r=this.graph.beats[t];r.neighbours=r.neighbours.filter(t=>t.destination.index<e)}}filterOutSequentialBranches(){for(let t=this.graph.beats.length-1;1<=t;t--){let e=this.graph.beats[t];e.neighbours=e.neighbours.filter(t=>!this.hasSequentialBranch(e,t))}}hasSequentialBranch(t,e){if(t.index!==this.graph.lastBranchPoint){var r=t.previous;if(null!==r){var n=t.index-e.destination.index;for(const i of r.neighbours)if(n==r.index-i.destination.index)return!0}}return!1}},Gt=class{constructor(t,e){this.songState=t,this.settings=e,this.playerSubscription=new u,this.currentBeat=null,this.bouncing=!1,this.bounceSeed=null,this.bounceCount=0,this.lastBranch=null,this.isSeekingResolver=null,this.beatsSinceLastBranch=0,this.onProgressSubject=new k,this.onProgress$=this.onProgressSubject.asObservable(),this.onBounceKeyDown=t=>{"Shift"===t.key&&(this.bouncing=!0)},this.onBounceKeyUp=t=>{"Shift"===t.key&&(this.bouncing=!1)}}start(){this.logDebug("Driver started."),document.addEventListener("keydown",this.onBounceKeyDown),document.addEventListener("keyup",this.onBounceKeyUp);var s,o,t=L(Spicetify.Player,"onprogress").pipe(kt(t=>t.data/1e3),(void 0===o&&(o=yt),s=null!=s?s:Mt,gt(function(t,r){var n,i=!0;t.subscribe(E(r,function(t){var e=o(t);!i&&s(n,e)||(i=!1,n=e,r.next(t))}))}))).subscribe(t=>this.process(t));this.playerSubscription.add(t)}process(t){if(null!==this.isSeekingResolver){if(this.logDebug(`Is seeking... ${t} -> `+(null==(e=this.currentBeat)?void 0:e.start)),!this.isSeekingResolver(t))return;this.isSeekingResolver=null}if(this.logDebug(`Processing with current beat: ${null==(e=this.currentBeat)?void 0:e.index}, current beat time: ${null==(e=this.currentBeat)?void 0:e.start} - ${null==(e=this.currentBeat)?void 0:e.end}, player time: `+this.getPlayerProgress()),null!==this.lastBranch&&this.setLastBranchPlaying(!1),null!==this.currentBeat){if(t<this.currentBeat.start+this.currentBeat.duration)return;this.currentBeat.isPlaying=!1}this.beatsSinceLastBranch++;var e=null!==this.currentBeat&&null!==this.currentBeat.next&&t>this.currentBeat.next.end,r=this.currentBeat;this.currentBeat=this.getNextBeat(t,e),null!==this.currentBeat&&(this.logDebug(`Got next beat: ${null==(t=this.currentBeat)?void 0:t.index}, with time: ${null==(t=this.currentBeat)?void 0:t.start} - ${null==(t=this.currentBeat)?void 0:t.end}, player time: `+this.getPlayerProgress()),this.playBeat(r,this.currentBeat,e),this.currentBeat.playCount+=1,this.songState.beatsPlayed+=1,null!==r&&(r.isPlaying=!1),this.currentBeat.isPlaying=!0,this.onProgressSubject.next())}getPlayerProgress(){return Spicetify.Player.getProgress()/1e3}async playBeat(t,r,n){if(null!==t&&t.index+1!=r.index&&!n){n=t.next,t=this.getPlayerProgress()-n.start;let e=r.start+t;this.logDebug("Seek to: "+e);n=e>this.getPlayerProgress();this.isSeekingResolver=n?t=>t>=e:t=>t<=e+1,Spicetify.Player.seek(1e3*e)}}getNextBeat(e,r){if(null===this.currentBeat){for(const t of this.songState.graph.beats)if(e>=t.start&&e<=t.end)return t;return this.songState.graph.beats[0]}if(r){console.error(`Out of sync ! ${e} > `+(null==(r=this.currentBeat.next)?void 0:r.end));let t=this.currentBeat.next;for(;null!==t&&!(e>=t.start&&e<=t.end);)t=t.next;return null===t?(this.stop(),null):t}return this.bouncing?(null===this.bounceSeed&&(this.bounceSeed=this.currentBeat,this.bounceCount=0),this.bounceCount++%2==1?this.selectNextNeighbor(this.bounceSeed):this.bounceSeed):null!=this.bounceSeed?(r=this.bounceSeed,this.bounceSeed=null,r):(r=this.currentBeat.index+1)>=this.songState.graph.beats.length?(this.stop(),null):this.selectRandomNextBeat(this.songState.graph.beats[r])}selectRandomNextBeat(t){var e;return 0!=t.neighbours.length&&this.shouldRandomBranch(t)?(e=t.neighbours.shift(),t.neighbours.push(e),this.beatsSinceLastBranch=0,this.lastBranch=e,this.setLastBranchPlaying(!0),e.destination):t}setLastBranchPlaying(t){null!==this.lastBranch&&(this.lastBranch.isPlaying=t,this.lastBranch.source.isPlaying=t,this.lastBranch.destination.isPlaying=t)}selectNextNeighbor(t){var e;return 0==t.neighbours.length?t:(e=t.neighbours.shift(),t.neighbours.push(e),this.lastBranch=e,this.setLastBranchPlaying(!0),e.destination)}shouldRandomBranch(t){if(t.index==this.songState.graph.lastBranchPoint)return!0;if(this.beatsSinceLastBranch<=this.settings.minBeatsBeforeBranching)return!1;this.songState.currentRandomBranchChance+=this.settings.randomBranchChanceDelta,this.songState.currentRandomBranchChance>this.settings.maxRandomBranchChance&&(this.songState.currentRandomBranchChance=this.settings.maxRandomBranchChance);t=Math.random()<this.songState.currentRandomBranchChance;return t&&(this.songState.currentRandomBranchChance=this.settings.minRandomBranchChance),t}stop(){this.playerSubscription.unsubscribe(),this.playerSubscription=new u,document.removeEventListener("keydown",this.onBounceKeyDown),document.removeEventListener("keyup",this.onBounceKeyUp)}logDebug(t){}},Kt=class{constructor(){this._songState=null,this.songStateSubject=new Pt(null),this.songState$=this.songStateSubject.asObservable(),this.driver=null,this._isEnabled=!1,this.songChangedSubscription=new u,this.driverProcessSubscription=new u,this.statsChangedSubject=new k,this.statsChanged$=this.statsChangedSubject.asObservable(),this.settings=new qt}get songState(){return this._songState}set songState(t){this._songState=t,this.songStateSubject.next(t)}get isEnabled(){return this._isEnabled}set isEnabled(t){(this._isEnabled=t)?this.enable():this.disable()}async enable(){await this.start();var t=L(Spicetify.Player,"songchange").subscribe(()=>{this.stop(),this.start()});this.songChangedSubscription.add(t)}disable(){this.stop(),this.songChangedSubscription.unsubscribe(),this.songChangedSubscription=new u}stop(){var t;null!=(t=this.driver)&&t.stop(),this.driver=null,this.driverProcessSubscription.unsubscribe(),this.driverProcessSubscription=new u,this.songState=null}async start(){var t,e,r=Spicetify.Player.data.track;void 0!==r&&(Spicetify.showNotification("Fetching analysis for song..."),e=Spicetify.URI.fromString(r.uri),t=null!=(t=(e=e)._base62Id)?t:e.id,null===(e=await Spicetify.CosmosAsync.get("wg://audio-attributes/v1/audio-analysis/"+t))&&(Spicetify.showNotification("No analysis available for this track.",!0),this.disable()),t=new V(e).remixTrack(),e=new Ut(this.settings,t.beats).generateGraph(),this.songState=new W(r,t,e),this.driver=new Gt(this.songState,this.settings),this.driverProcessSubscription.add(this.driver.onProgress$.subscribe(()=>{this.statsChangedSubject.next()})),this.driver.start())}};(async()=>{for(;null==Spicetify||!Spicetify.Platform;)await new Promise(t=>setTimeout(t,100));var n,t=Spicetify.ReactDOM,e=(n=".player-controls__right",await new Promise(e=>{var t=document.querySelector(n);if(null!==t)return e(t);const r=new MutationObserver(()=>{var t=document.querySelector(n);null!==t&&(e(t),r.disconnect())});r.observe(document.body,{childList:!0,subtree:!0})}));window.jukebox=new Kt,t.render(t.createPortal(G.default.createElement(H,null),e),document.createElement("div"))})()})();